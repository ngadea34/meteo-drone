<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calendrier météo drone — vent & seuil couleur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Local : python -m http.server 3000 -->
  <style>
    :root {
      --bg-color: #121212;
      --fg-color: #e0e0e0;
      --accent-color: #90caf9;
      --border-color: #333;
      --muted: #9aa0a6;
    }
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(180deg,#0f1116,#111624 40%,#0f1116);
      color: var(--fg-color);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      margin: 0;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 8px 12px;
      align-items: center;
    }
    .controls, .loc-controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .chip { background:#1c2233; border:1px solid #27324a; color:#cfe3ff; padding:6px 10px; border-radius:10px; }
    button, input[type="number"], input[type="text"], select, label {
      background-color: #1b1f2b;
      color: var(--fg-color);
      border: 1px solid var(--border-color);
      padding: 6px 10px;
      border-radius: 8px;
    }
    button { cursor: pointer; }
    button:hover { background-color: #232a3a; }
    input[type="checkbox"]{ transform: scale(1.1); margin-right: 4px; vertical-align: middle; }
    #weekday-headers, #calendar {
      width: 100%;
      max-width: 1000px;
      margin: 8px auto 0;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      border: 1px solid var(--border-color);
      border-bottom: none;
    }
    #calendar { border-top: none; border-bottom: 1px solid var(--border-color); grid-auto-rows: minmax(110px,auto); }
    .weekday-header { text-align: center; font-weight: 600; padding: 8px; background-color: #171c29; border-right: 1px solid var(--border-color); }
    .weekday-header:last-child{ border-right: none; }
    .day-cell { padding: 8px; background-color: #101521; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); display:flex; flex-direction: column; justify-content: space-between; }
    .day-cell.indisponible { background-color: #1a2233; color: #b8c0cc; }
    .day-cell.today { outline: 2px solid var(--accent-color); outline-offset: -2px; }
    .day-number { font-weight: 700; font-size: .95rem; opacity:.95; }
    .day-info { font-size: .82rem; color: #eef5ff; }
    #status { margin-left: 8px; color: var(--muted); font-size: .9rem; }
    #debug-panel { background:#0f1422; border-top:1px solid #26324b; padding:10px 12px; font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; color:#a6d3ff; max-height: 220px; overflow:auto; }
    #debug-toggle { position: fixed; bottom: 12px; right: 12px; background: var(--accent-color); color:#000; border:0; width: 36px; height: 36px; border-radius: 50%; cursor:pointer; font-weight:700; }
    .muted { color: var(--muted); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <button id="prev-month">⟵</button>
      <div id="month-label" class="chip" style="min-width:180px;text-align:center">—</div>
      <button id="next-month">⟶</button>
      <button id="today-btn">Aujourd’hui</button>
      <button id="export-ics">Export .ics</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="controls">
      <label>Profil
        <select id="profile-select">
          <option value="inspection">Inspection toiture</option>
          <option value="thermo">Thermographie PV</option>
          <option value="nettoyage">PV Cleaning / Nettoyage</option>
          <option value="pulverisation">Démoussage / Pulvérisation</option>
        </select>
      </label>
      <label>Seuil favorable
        <input type="number" id="threshold-input" min="0" max="100" step="1" style="width:80px">
      </label>
      <label class="row"><input type="checkbox" id="mode-conservateur"> Mode conservateur</label>
      <label class="row"><input type="checkbox" id="mode-hors-ligne"> Mode hors-ligne</label>
    </div>

    <div class="loc-controls">
      <div id="lieu-info" class="chip">Montpellier centre (43.62000, 3.88000)</div>
      <input type="text" id="address-input" placeholder="Saisir une adresse ou ville…">
      <button id="btn-geocode" title="Rechercher l’adresse et centrer">Mettre à jour le lieu</button>
      <button id="btn-setll" title="Saisir lat/lon manuellement">Lat/Lon</button>
    </div>
  </header>

  <div id="weekday-headers">
    <div class="weekday-header">Lun</div><div class="weekday-header">Mar</div><div class="weekday-header">Mer</div>
    <div class="weekday-header">Jeu</div><div class="weekday-header">Ven</div><div class="weekday-header">Sam</div><div class="weekday-header">Dim</div>
  </div>
  <div id="calendar"></div>

  <div id="debug-panel">
    <strong>Debug</strong>
    <div id="debug-content"></div>
  </div>
  <button id="debug-toggle">⋯</button>

  <script>
  (function(){
    try {
      /* Profils (seuils par défaut + limites vent) */
      var PROFILES = {
        inspection:     { defaultThreshold: 65, demoussage: { windIdealMax: 25, windHardMax: 50, rainStrict: false, tempMin: 20, tempMax: 35 } },
        thermo:         { defaultThreshold: 70, demoussage: { windIdealMax: 15, windHardMax: 30, rainStrict: false, tempMin: 15, tempMax: 35 } },
        nettoyage:      { defaultThreshold: 70, demoussage: { windIdealMax: 15, windHardMax: 30, rainStrict: false, tempMin: 10, tempMax: 30 } },
        pulverisation:  { defaultThreshold: 75, demoussage: { windIdealMax: 12, windHardMax: 20, rainStrict: true,  tempMin: 8,  tempMax: 30 } }
      };
      var HARD_WIND_MAX = { inspection: 45, thermo: 35, nettoyage: 40, pulverisation: 20 }; // km/h

      /* Paramétrage couleur vent ↔ seuil */
      var MIN_GREEN_WIND = 10; // km/h : vert garanti si seuil=100 (exigeant)

      function windGreenMaxFromSeuil(seuil, windNoFly){
        // seuil=0 -> greenMax ~ noFly ; seuil=100 -> greenMax = MIN_GREEN_WIND
        var g = MIN_GREEN_WIND + (1 - (seuil/100)) * (windNoFly - MIN_GREEN_WIND);
        return Math.max(MIN_GREEN_WIND, Math.min(windNoFly-1, Math.round(g)));
      }
      function paintByWind(cell, wind, seuil, windNoFly){
        var gMax = windGreenMaxFromSeuil(seuil, windNoFly);
        var bg, fg;
        if (wind >= windNoFly) { bg='hsl(0,75%,45%)'; fg='#fff'; }          // rouge : no-fly
        else if (wind > gMax)  { bg='hsl(45,90%,50%)'; fg='#000'; }         // jaune : entre vert et no-fly
        else                   { bg='hsl(130,75%,40%)'; fg='#fff'; }         // vert : vent ≤ gMax
        cell.style.backgroundColor = bg; cell.style.color = fg;
      }

      /* État */
      var currentDate = new Date(); currentDate.setDate(1); currentDate.setHours(0,0,0,0);
      var lieu = { lat: 43.62, lon: 3.8799996, name: 'Montpellier centre' };
      var modeConservateur = false, modeHorsLigne = false;
      var profile = 'inspection';
      var seuilFavorable = PROFILES[profile].defaultThreshold;

      // Restauration lieu
      try{ var raw=localStorage.getItem('calLieu'); if(raw){ var o=JSON.parse(raw); if(o&&typeof o.lat==='number'){ lieu=o; } } }catch(_e){}

      /* Debug */
      var debug = { urls:[], statusCodes:[], renderedCells:0, daysAggregated:0, errors:[] };

      /* DOM */
      var prevBtn=document.getElementById('prev-month'), nextBtn=document.getElementById('next-month'), todayBtn=document.getElementById('today-btn');
      var exportBtn=document.getElementById('export-ics'), profileSelect=document.getElementById('profile-select'), thresholdInput=document.getElementById('threshold-input');
      var conservCheckbox=document.getElementById('mode-conservateur'), offlineCheckbox=document.getElementById('mode-hors-ligne');
      var calendarEl=document.getElementById('calendar'), debugContent=document.getElementById('debug-content'), debugPanel=document.getElementById('debug-panel');
      var debugToggle=document.getElementById('debug-toggle'), addressInput=document.getElementById('address-input'), btnGeocode=document.getElementById('btn-geocode');
      var btnSetLL=document.getElementById('btn-setll'), lieuInfo=document.getElementById('lieu-info'), monthLabel=document.getElementById('month-label'), statusEl=document.getElementById('status');

      function updateLieuInfo(){ lieuInfo.textContent=(lieu.name||'Lieu')+' ('+lieu.lat.toFixed(5)+', '+lieu.lon.toFixed(5)+')'; }
      function persistLieu(){ try{ localStorage.setItem('calLieu', JSON.stringify(lieu)); }catch(_e){} }
      updateLieuInfo(); thresholdInput.value=String(seuilFavorable);

      /* UI */
      debugToggle.addEventListener('click', function(){ debugPanel.style.display = (debugPanel.style.display==='none')?'block':'none'; });
      prevBtn.addEventListener('click', function(){ currentDate.setMonth(currentDate.getMonth()-1); render(); });
      nextBtn.addEventListener('click', function(){ currentDate.setMonth(currentDate.getMonth()+1); render(); });
      todayBtn.addEventListener('click', function(){ var t=new Date(); t.setDate(1); t.setHours(0,0,0,0); currentDate=t; render(); });
      profileSelect.addEventListener('change', function(){ profile=profileSelect.value; seuilFavorable=PROFILES[profile].defaultThreshold; thresholdInput.value=String(seuilFavorable); render(); });
      thresholdInput.addEventListener('input', function(){ var v=parseInt(thresholdInput.value,10); if(!isNaN(v)&&v>=0&&v<=100){ seuilFavorable=v; render(false); } });
      conservCheckbox.addEventListener('change', function(){ modeConservateur=conservCheckbox.checked; render(false); });
      offlineCheckbox.addEventListener('change', function(){ modeHorsLigne=offlineCheckbox.checked; render(); });
      exportBtn.addEventListener('click', exportICS);

      btnGeocode.addEventListener('click', setLocationFromAddress);
      btnSetLL.addEventListener('click', function(){
        var lat=prompt('Latitude ?', String(lieu.lat)), lon=prompt('Longitude ?', String(lieu.lon));
        if(lat&&lon&&!isNaN(parseFloat(lat))&&!isNaN(parseFloat(lon))){ lieu.lat=parseFloat(lat); lieu.lon=parseFloat(lon); lieu.name='Coordonnées manuelles'; persistLieu(); updateLieuInfo(); render(); }
      });

      function addDays(d,n){ var x=new Date(d); x.setDate(x.getDate()+n); return x; }
      function ymd(d){ var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }
      function monthFR(d){ try{ return d.toLocaleString('fr-FR',{month:'long',year:'numeric'});}catch(_e){ return d.getFullYear()+'-'+(d.getMonth()+1);} }

      /* Géocodage OSM */
      async function geocodeAddress(q){
        var u=new URL('https://nominatim.openstreetmap.org/search'); u.searchParams.set('q',q); u.searchParams.set('format','json'); u.searchParams.set('limit','1');
        var res=await fetch(u.toString(),{headers:{'Accept':'application/json'}}); if(!res.ok) throw new Error('Geocode HTTP '+res.status);
        var arr=await res.json(); if(!arr||!arr.length) throw new Error('Adresse introuvable');
        return {lat:parseFloat(arr[0].lat), lon:parseFloat(arr[0].lon), name:arr[0].display_name};
      }
      async function setLocationFromAddress(){
        var q=addressInput.value.trim(); if(!q){ alert('Saisis une adresse ou une ville.'); return; }
        try{ statusEl.textContent='Géocodage…'; var r=await geocodeAddress(q); lieu.lat=r.lat; lieu.lon=r.lon; lieu.name=r.name||q; persistLieu(); updateLieuInfo(); statusEl.textContent='Lieu mis à jour.'; render(); }
        catch(e){ statusEl.textContent='Erreur géocodage'; alert('Adresse introuvable ou service indisponible : '+(e&&e.message?e.message:e)); }
      }

      /* Fetch météo */
      async function fetchWeather(startDate, endDate){
        var today=new Date(); today.setHours(0,0,0,0); var horizon=addDays(today,15);
        var realStart=startDate<today?today:startDate, realEnd=endDate>horizon?horizon:endDate; if(realStart>realEnd) return {daily:{time:[]}};
        var all={daily:{time:[],precipitation_sum:[],rain_sum:[],wind_gusts_10m_max:[],temperature_2m_max:[],temperature_2m_min:[],cloudcover_mean:[],shortwave_radiation_sum:[]}};
        var cur=new Date(realStart), ps=[];
        while(cur<=realEnd){
          var s=new Date(cur), e=(addDays(s,15)<realEnd)?addDays(s,15):new Date(realEnd);
          var p=new URLSearchParams({latitude:String(lieu.lat),longitude:String(lieu.lon),daily:'precipitation_sum,rain_sum,wind_gusts_10m_max,temperature_2m_max,temperature_2m_min,cloudcover_mean,shortwave_radiation_sum',timezone:'Europe/Paris',start_date:ymd(s),end_date:ymd(e)});
          var url='https://api.open-meteo.com/v1/forecast?'+p.toString(); debug.urls.push(url);
          ps.push(fetch(url).then(function(r){ debug.statusCodes.push(r.status); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(j){ var d=j.daily||{}; ['time','precipitation_sum','rain_sum','wind_gusts_10m_max','temperature_2m_max','temperature_2m_min','cloudcover_mean','shortwave_radiation_sum'].forEach(function(k){ if(Array.isArray(d[k])) all.daily[k]=all.daily[k].concat(d[k]); }); })
            .catch(function(err){ debug.errors.push({url:url,error:String(err)}); })
          );
          cur=addDays(e,1);
        }
        await Promise.all(ps); return all;
      }

      /* Score (pour étiquette + ICS) + no-fly vent */
      function scoreForDay(d){
        if(modeHorsLigne){ return {score: Math.floor(seuilFavorable)+Math.floor(Math.random()*(101-seuilFavorable))}; }
        var wind=Number(d.wind_gusts_10m_max||0), rain=Number(d.rain_sum!=null?d.rain_sum:(d.precipitation_sum!=null?d.precipitation_sum:0));
        var irr=(Number(d.shortwave_radiation_sum||0))*277.78, tmax=Number(d.temperature_2m_max||0), tmin=Number(d.temperature_2m_min||0);
        var noFly=HARD_WIND_MAX[profile]!=null?HARD_WIND_MAX[profile]:999; if(wind>=noFly) return {score:0,flags:{noFlyWind:true}};
        var s=0;
        if(profile==='thermo'){ var ws=wind<=15?1:(wind>=35?0:(1-(wind-15)/20)), rs=rain===0?1:(rain<2?0.6:0.1), is=irr<=2500?(irr/2500):(irr>=5000?1:((irr-2500)/2500)), tm=(tmax+tmin)/2, ts=Math.abs(tm-24)>=10?0:(1-Math.abs(tm-24)/10); s=(0.35*ws+0.40*rs+0.20*is+0.05*ts)*100; }
        else if(profile==='nettoyage'){ var ws2=wind<=20?1:(wind>=40?0:(1-(wind-20)/20)), rs2=rain===0?1:(rain<1?0.7:0.05), tm2=(tmax+tmin)/2, ts2=Math.abs(tm2-22)>=10?0:(1-Math.abs(tm2-22)/10); s=(0.45*ws2+0.45*rs2+0.10*ts2)*100; }
        else if(profile==='inspection'){ var ws3=wind<=25?1:(wind>=50?0:(1-(wind-25)/25)), rs3=rain===0?1:(rain<2?0.6:0.1), tm3=(tmax+tmin)/2, ts3=Math.abs(tm3-20)>=10?0:(1-Math.abs(tm3-20)/10); s=(0.50*ws3+0.45*rs3+0.05*ts3)*100; }
        else { var prm=PROFILES.pulverisation.demoussage, ws4=wind<=prm.windIdealMax?1:(wind>=prm.windHardMax?0:(1-(wind-prm.windIdealMax)/(prm.windHardMax-prm.windIdealMax))), rs4=prm.rainStrict?(rain===0?1:0):(rain===0?1:(rain<1?0.7:0.1)), diff=0; if(tmin<prm.tempMin) diff+=prm.tempMin-tmin; if(tmax>prm.tempMax) diff+=tmax-prm.tempMax; var ts4=Math.max(0,1-diff/10); s=(0.55*ws4+0.35*rs4+0.10*ts4)*100; }
        var noFly80=(HARD_WIND_MAX[profile]||999)*0.8; if(modeConservateur && (wind>=noFly80 || rain>=1)) s=Math.max(0,s-10);
        return {score:s};
      }

      /* Rendu */
      async function render(fetchNow){ if(fetchNow===undefined) fetchNow=true;
        debug.urls=[]; debug.statusCodes=[]; debug.errors=[]; debug.renderedCells=0; debug.daysAggregated=0;
        calendarEl.innerHTML=''; debugContent.textContent=''; monthLabel.textContent=monthFR(currentDate);

        var y=currentDate.getFullYear(), m=currentDate.getMonth(), first=new Date(y,m,1), last=new Date(y,m+1,0);
        var startWeekDay=(first.getDay()+6)%7; for(var i=0;i<startWeekDay;i++){ var e=document.createElement('div'); e.className='day-cell indisponible'; calendarEl.appendChild(e); }
        var today=new Date(); today.setHours(0,0,0,0);

        var daysInMonth=last.getDate(), minDate=new Date(y,m,1), maxDate=new Date(y,m,daysInMonth);
        var data=fetchNow?await fetchWeather(minDate,maxDate):{daily:{time:[]}}, wd=(data.daily&&Array.isArray(data.daily.time))?{}:null;
        if(wd){ data.daily.time.forEach(function(ts,idx){ wd[ts]={precipitation_sum:Number(data.daily.precipitation_sum&&data.daily.precipitation_sum[idx]!=null?data.daily.precipitation_sum[idx]:0), rain_sum:Number(data.daily.rain_sum&&data.daily.rain_sum[idx]!=null?data.daily.rain_sum[idx]:(data.daily.precipitation_sum&&data.daily.precipitation_sum[idx]!=null?data.daily.precipitation_sum[idx]:0)), wind_gusts_10m_max:Number(data.daily.wind_gusts_10m_max&&data.daily.wind_gusts_10m_max[idx]!=null?data.daily.wind_gusts_10m_max[idx]:0), temperature_2m_max:Number(data.daily.temperature_2m_max&&data.daily.temperature_2m_max[idx]!=null?data.daily.temperature_2m_max[idx]:0), temperature_2m_min:Number(data.daily.temperature_2m_min&&data.daily.temperature_2m_min[idx]!=null?data.daily.temperature_2m_min[idx]:0), cloudcover_mean:Number(data.daily.cloudcover_mean&&data.daily.cloudcover_mean[idx]!=null?data.daily.cloudcover_mean[idx]:0), shortwave_radiation_sum:Number(data.daily.shortwave_radiation_sum&&data.daily.shortwave_radiation_sum[idx]!=null?data.daily.shortwave_radiation_sum[idx]:0)}; }); }

        var noFly = HARD_WIND_MAX[profile]||999;
        for(var d=1; d<=daysInMonth; d++){
          var dt=new Date(y,m,d), cell=document.createElement('div'); cell.className='day-cell';
          var dn=document.createElement('div'); dn.className='day-number'; dn.textContent=String(d); cell.appendChild(dn);
          if(dt.getTime()===today.getTime()) cell.classList.add('today');
          var info=document.createElement('div'); info.className='day-info'; var k=ymd(dt);

          if(modeHorsLigne){
            var windSim=Math.round(Math.random()*noFly); paintByWind(cell, windSim, seuilFavorable, noFly);
            info.textContent='Simulé · vent '+windSim+' km/h';
          } else if(wd && wd[k]){
            var w=wd[k].wind_gusts_10m_max; paintByWind(cell, w, seuilFavorable, noFly);
            var r=scoreForDay(wd[k]); var score=Math.round(r.score); debug.daysAggregated++;
            var cat=(score>=seuilFavorable)?'Favorable':(score>=45?'Limite':'Défavorable');
            var extra=(r.flags&&r.flags.noFlyWind)?' · no-fly vent':'';
            info.textContent=cat+extra+' · vent '+w+' km/h · pluie '+wd[k].rain_sum+' mm · T° '+wd[k].temperature_2m_min+'-'+wd[k].temperature_2m_max+' °C';
          } else {
            cell.classList.add('indisponible'); info.textContent='Météo indisponible';
          }
          cell.appendChild(info); calendarEl.appendChild(cell); debug.renderedCells++;
        }

        var total=debug.renderedCells+startWeekDay, rem=total%7; if(rem!==0){ var add=7-rem; for(var j=0;j<add;j++){ var e2=document.createElement('div'); e2.className='day-cell indisponible'; calendarEl.appendChild(e2); } }

        var L=[]; L.push('Profil: '+profile); L.push('Seuil favorable: '+seuilFavorable); L.push('Vent no-fly (profil): '+noFly+' km/h'); L.push('Seuil vent vert: '+windGreenMaxFromSeuil(seuilFavorable,noFly)+' km/h'); L.push('Lieu: '+(lieu.name||'Lieu')+' ('+lieu.lat.toFixed(5)+', '+lieu.lon.toFixed(5)+')'); L.push('URLs: '+debug.urls.length);
        debug.urls.forEach(function(u,i){ L.push('• '+u+' → HTTP '+(debug.statusCodes[i]!=null?debug.statusCodes[i]:'-')); });
        L.push('Jours avec données météo: '+debug.daysAggregated); L.push('Cases rendues: '+debug.renderedCells);
        if(debug.errors.length){ L.push('Erreurs:'); debug.errors.forEach(function(e){ L.push('• '+e.url+' → '+e.error); }); }
        debugContent.textContent=L.join('\n');
      }

      /* Export ICS (jours favorables selon profil) */
      function exportICS(){
        var y=currentDate.getFullYear(), m=currentDate.getMonth(), last=new Date(y,m+1,0), days=last.getDate();
        var minDate=new Date(y,m,1), maxDate=new Date(y,m,days);
        fetchWeather(minDate,maxDate).then(function(data){
          var wd=(data.daily&&Array.isArray(data.daily.time))?{}:null;
          if(wd){ data.daily.time.forEach(function(ts,idx){ wd[ts]={precipitation_sum:Number(data.daily.precipitation_sum&&data.daily.precipitation_sum[idx]!=null?data.daily.precipitation_sum[idx]:0), rain_sum:Number(data.daily.rain_sum&&data.daily.rain_sum[idx]!=null?data.daily.rain_sum[idx]:(data.daily.precipitation_sum&&data.daily.precipitation_sum[idx]!=null?data.daily.precipitation_sum[idx]:0)), wind_gusts_10m_max:Number(data.daily.wind_gusts_10m_max&&data.daily.wind_gusts_10m_max[idx]!=null?data.daily.wind_gusts_10m_max[idx]:0), temperature_2m_max:Number(data.daily.temperature_2m_max&&data.daily.temperature_2m_max[idx]!=null?data.daily.temperature_2m_max[idx]:0), temperature_2m_min:Number(data.daily.temperature_2m_min&&data.daily.temperature_2m_min[idx]!=null?data.daily.temperature_2m_min[idx]:0), cloudcover_mean:Number(data.daily.cloudcover_mean&&data.daily.cloudcover_mean[idx]!=null?data.daily.cloudcover_mean[idx]:0), shortwave_radiation_sum:Number(data.daily.shortwave_radiation_sum&&data.daily.shortwave_radiation_sum[idx]!=null?data.daily.shortwave_radiation_sum[idx]:0)}; }); }
          var ev=[];
          for(var d=1; d<=days; d++){
            var dt=new Date(y,m,d), k=ymd(dt);
            if(wd && wd[k]){ var s=Math.round(scoreForDay(wd[k]).score); if(s>=seuilFavorable){
              var ds=k.replace(/-/g,''), de=(new Date(y,m,d+1)).toISOString().slice(0,10).replace(/-/g,'');
              var desc='Vent: '+wd[k].wind_gusts_10m_max+' km/h\nPluie: '+wd[k].rain_sum+' mm\nT°: '+wd[k].temperature_2m_min+'-'+wd[k].temperature_2m_max+' °C\nNébulosité: '+wd[k].cloudcover_mean+'%\nIrradiance: '+Math.round((wd[k].shortwave_radiation_sum||0)*277.78)+' Wh/m²';
              ev.push('BEGIN:VEVENT\nDTSTART;VALUE=DATE:'+ds+'\nDTEND;VALUE=DATE:'+de+'\nSUMMARY:Fenêtre météo favorable ('+s+') — '+(lieu.name||'Lieu')+'\nDESCRIPTION:'+desc+'\nEND:VEVENT');
            }}
          }
          if(!ev.length){ alert('Aucun jour favorable à exporter.'); return; }
          var ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Calendrier Meteo Drone//FR'].concat(ev).concat('END:VCALENDAR').join('\r\n');
          var blob=new Blob([ics],{type:'text/calendar;charset=utf-8'}), url=URL.createObjectURL(blob), a=document.createElement('a');
          a.href=url; a.download='favorable_'+y+'_'+('0'+(m+1)).slice(-2)+'.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });
      }

      render();
    } catch (e) {
      var d=document.getElementById('debug-content'); if(d) d.textContent='ERREUR INIT JS : '+(e&&e.stack?e.stack:e);
      console.error(e);
    }
  })();
  </script>
</body>
</html>
