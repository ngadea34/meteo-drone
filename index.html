<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CDC – Devis Cleaner Drone Crew</title>
  <style>
    :root {
      --bleu: #1778F2;
      --orange: #FF7A00;
      --gris: #f4f4f4;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #fff;
      color: #000;
    }

    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: var(--bleu);
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    header .actions button {
      margin-left: 10px;
    }

    main {
      margin-top: 60px;
      display: flex;
    }

    .col-gauche {
      width: 65%;
      padding: 10px;
    }

    .col-droite {
      width: 35%;
      padding: 10px;
      background: #fafafa;
      border-left: 1px solid #ddd;
    }

    section {
      margin-bottom: 20px;
      background: var(--gris);
      padding: 10px;
      border-radius: 4px;
    }

    h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: left;
    }

    th {
      background: #eee;
    }

    .fixed-btns {
      position: absolute;
      right: 10px;
      top: 10px;
    }

    #slideover {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: #fff;
      border-left: 2px solid #ccc;
      z-index: 20;
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
    }

    #slideover.open {
      right: 0;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--orange);
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 100;
    }

    .toast.show {
      opacity: 1;
    }

    .addon-offert {
      font-style: italic;
      color: #777;
    }

    .admin-tabs button.active {
      background: var(--orange);
      color: white;
    }

    .admin-content > div {
      display: none;
    }

    .admin-content > div.active {
      display: block;
    }

    @media print {
      header, .col-gauche .actions, .fixed-btns, #slideover, button {
        display: none !important;
      }

      body {
        background: white;
      }

      .col-gauche, .col-droite {
        width: 100%;
        float: none;
        padding: 0;
      }

      section {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>CDC Cleaner Drone Crew</h1>
    <div class="actions">
      <button onclick="newDevis()">Nouveau devis</button>
      <button onclick="showAdmin()">Admin</button>
      <button onclick="window.print()">Imprimer</button>
    </div>
  </header>
  <main>
    <div class="col-gauche">
      <section id="sec-client">
        <h2>Client</h2>
        <label>Téléphone:<br><input id="client-phone"></label><br>
        <label>Adresse chantier:<br><input id="client-address"></label>
      </section>
      <section id="sec-prestations">
        <h2>Prestations (lignes)</h2>
        <button onclick="openLine()">Ajouter ligne</button>
        <table id="table-lignes">
          <thead>
            <tr>
              <th>Prestation</th>
              <th>Add-ons</th> <!-- ✅ AJOUT -->
              <th>Qté</th>
              <th>Unité</th>
              <th>PU</th>
              <th>Min forfait</th>
              <th>Hors 34-30</th>
              <th>HT ligne</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="lignes-body">
            <!-- lignes JS -->
          </tbody>
        </table>
      </section>
      <section id="sec-addons">
        <h2>Add-ons</h2>
        <ul id="global-addons-list">
          <!-- Liste des add-ons choisis, générée dynamiquement -->
        </ul>
      </section>
      <section id="sec-deplacement">
        <h2>Déplacement</h2>
        <label><input type="checkbox" id="hors3430"> Hors Hérault/Gard</label>
      </section>
      <section id="sec-remise">
        <h2>Remise globale (%)</h2>
        <input type="number" id="remise-global" min="0" max="100" value="0">
      </section>
      <section id="sec-envoi">
        <h2>Validation & Envoi</h2>
        <label><input type="checkbox" id="rgpd-ok"> J’accepte l’envoi par email et la conservation locale de mon devis.</label><br>
        <button onclick="telechargerPDF()">Télécharger PDF</button>
        <button onclick="envoyerMail()">Envoyer par email</button>
      </section>
    </div>
    <div class="col-droite">
      <div id="resume">
        <p><strong>Devis N° :</strong> <span id="devis-num"></span></p>
        <p>Total HT : <span id="total-ht">0.00 €</span></p>
        <p>Remise : <span id="total-remise">0.00 €</span></p>
        <p>TVA (20 %) : <span id="total-tva">0.00 €</span></p>
        <p>Total TTC : <span id="total-ttc">0.00 €</span></p>
        <p>Acompte (30 %) : <span id="total-acompte">0.00 €</span></p>
        <p>Reste dû : <span id="total-reste">0.00 €</span></p>
      </div>
    </div>
  </main>

  <!-- SlideOver -->
  <div id="slideover"></div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- JS inline -->
  <script>
    const ls = localStorage;
    const ID = (id) => document.getElementById(id);
    const showToast = (msg) => {
      const t = ID("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2000);
    };

    // --- Modèle de données (simplifié ici, étendu après)
    let config = {
      colors: { blue: "#1778F2", orange: "#FF7A00" },
      tva: 0.20,
      remisePct: 0,
      forfaitHors3430: 150,
      mentionsPdf: "Interventions dépendantes des conditions météo (vent/pluie/températures). En cas d’annulation météo, reprogrammation rapide garantie dès que les conditions sont favorables.",
      company: {
        name: "CDC Cleaner Drone Crew",
        siren: "123 456 789",
        address: "1 rue du Drone, 34000 Montpellier",
        email: "contact@cdc.fr",
        phone: "04 11 22 33 44",
        iban: "FR76 3000 4000 5000 6000 7000 189",
        cgvUrl: "https://cdc.fr/cgv"
      }
    };

    let prestations = [
      { id:"toitures", label:"Nettoyage toitures", unite:"€/m²", pu:9.5, min:520, cadence:55, desc:"Démoussage/anti-lichens, rinçage maîtrisé." },
      { id:"facades", label:"Façades (basse pression / softwash)", unite:"€/m²", pu:8.0, min:480, cadence:60, desc:"Solution douce, rinçage basse pression." },
      { id:"pvnet", label:"PV – Nettoyage", unite:"€/m²", pu:5.5, min:350, cadence:120, desc:"Eau osmosée (0 ppm), perches, sans additif." },
      { id:"pvthermo", label:"PV – Thermographie", unite:"€/site", pu:600, min:600, cadence:1, desc:"Inspection IR par drone, rapport synthétique." },
      { id:"vitrerie", label:"Vitrerie/Bardage", unite:"€/m²", pu:6.0, min:420, cadence:100, desc:"Perches/drones selon accès, essuyage si requis." },
      { id:"chenaux", label:"Chéneaux & gouttières", unite:"€/ml", pu:4.0, min:280, cadence:150, desc:"Débouchage, rinçage, contrôle d’écoulement." },
      { id:"inspection", label:"Inspection toiture (photo/vidéo + rapport)", unite:"€/site", pu:420, min:420, cadence:1, desc:"Inspection HD, rapport 48 h." }
    ];

    let addons = [
      { id:"demoussage", label:"Démoussage", type:"ligne", pu:50 },
      { id:"inspection_physique", label:"Inspection physique", type:"ligne", pu:80 },
      { id:"inspection_thermique", label:"Inspection thermique", type:"ligne", pu:120 }
    ];

    let lignes = []; // ← Ligne de devis (tableau des prestations)
    function calculerTotalHTLigne(ligne) {
      const base = Math.max(ligne.qte * ligne.pu, ligne.min);
      const addonsTotal = ligne.addons.reduce((sum, a) => sum + (a.offert ? 0 : a.pu), 0);
      return +(base + addonsTotal).toFixed(2);
    }

    function calculerTotaux() {
      let totalHT = lignes.reduce((sum, l) => sum + calculerTotalHTLigne(l), 0);
      if (ID("hors3430").checked) totalHT += config.forfaitHors3430;

      const remise = totalHT * (parseFloat(ID("remise-global").value || 0) / 100);
      const tva = (totalHT - remise) * config.tva;
      const ttc = totalHT - remise + tva;
      const acompte = ttc * 0.3;
      const reste = ttc - acompte;

      ID("total-ht").textContent = totalHT.toFixed(2) + " €";
      ID("total-remise").textContent = remise.toFixed(2) + " €";
      ID("total-tva").textContent = tva.toFixed(2) + " €";
      ID("total-ttc").textContent = ttc.toFixed(2) + " €";
      ID("total-acompte").textContent = acompte.toFixed(2) + " €";
      ID("total-reste").textContent = reste.toFixed(2) + " €";
    }

    function renderLignes() {
      const tbody = ID("lignes-body");
      tbody.innerHTML = "";
      lignes.forEach((l, idx) => {
        const tr = document.createElement("tr");

        const service = prestations.find(p => p.id === l.serviceId);
        const label = service ? service.label : "N/A";

        const addonsText = l.addons.map(a => {
          const addon = addons.find(ad => ad.id === a.addonId);
          return addon ? `${addon.label}${a.offert ? " (offert)" : ""}` : "";
        }).join(", ");

        tr.innerHTML = `
          <td>${label}</td>
          <td>${addonsText}</td>
          <td>${l.qte}</td>
          <td>${l.unite}</td>
          <td>${l.pu.toFixed(2)}</td>
          <td>${l.min.toFixed(2)}</td>
          <td>${l.hors3430 ? "Oui" : "Non"}</td>
          <td>${calculerTotalHTLigne(l).toFixed(2)}</td>
          <td>
            <button onclick="editLigne(${idx})">✏️</button>
            <button onclick="duplicateLigne(${idx})">📄</button>
            <button onclick="deleteLigne(${idx})">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      renderAddonsGlobal();
      calculerTotaux();
    }

    function renderAddonsGlobal() {
      const ul = ID("global-addons-list");
      ul.innerHTML = "";
      lignes.forEach((l, i) => {
        l.addons.forEach(a => {
          const addon = addons.find(ad => ad.id === a.addonId);
          const li = document.createElement("li");
          li.textContent = `Ligne ${i + 1} – ${addon.label} ${a.offert ? "(offert)" : `(${a.pu} €)`}`;
          ul.appendChild(li);
        });
      });
    }

    function openLine(idx = null) {
      const slide = ID("slideover");
      slide.classList.add("open");
      slide.innerHTML = ""; // clean
      const l = idx !== null ? lignes[idx] : null;
      const serviceOptions = prestations.map(s => `<option value="${s.id}">${s.label}</option>`).join("");

      slide.innerHTML = `
        <h3>${idx === null ? "Nouvelle ligne" : "Modifier ligne"}</h3>
        <label>Prestation:<br>
          <select id="s-presta">${serviceOptions}</select>
        </label><br>
        <label>Qté:<br><input type="number" id="s-qte"></label><br>
        <label>Unité:<br><input id="s-unite"></label><br>
        <label>PU:<br><input type="number" step="0.01" id="s-pu"></label><br>
        <label>Min forfait:<br><input type="number" step="0.01" id="s-min"></label><br>
        <label><input type="checkbox" id="s-hors"> Hors 34-30</label><br>
        <div id="s-addons"></div>
        <button onclick="validerLigne(${idx})">Valider</button>
        <button onclick="closeSlide()">Annuler</button>
      `;

      ID("s-presta").addEventListener("change", updateAddonsPanel);
      if (l) {
        ID("s-presta").value = l.serviceId;
        ID("s-qte").value = l.qte;
        ID("s-unite").value = l.unite;
        ID("s-pu").value = l.pu;
        ID("s-min").value = l.min;
        ID("s-hors").checked = l.hors3430;
      }
      updateAddonsPanel(l ? l.addons : []);
    }

    function updateAddonsPanel(existingAddons = []) {
      const container = ID("s-addons");
      const selectedService = ID("s-presta").value;
      container.innerHTML = "<p><strong>Add-ons :</strong></p>";

      addons.forEach(addon => {
        const exists = existingAddons.find(a => a.addonId === addon.id);
        const checked = exists ? "checked" : "";
        const offert = exists && exists.offert ? "checked" : "";
        container.innerHTML += `
          <label><input type="checkbox" class="addon" data-id="${addon.id}" ${checked}> ${addon.label} (${addon.pu.toFixed(2)} €)</label><br>
          <label style="margin-left:20px;"><input type="checkbox" class="offert" data-id="${addon.id}" ${offert}> Offert</label><br>
        `;
      });
    }

    function validerLigne(idx) {
      const line = {
        serviceId: ID("s-presta").value,
        qte: parseFloat(ID("s-qte").value),
        unite: ID("s-unite").value,
        pu: parseFloat(ID("s-pu").value),
        min: parseFloat(ID("s-min").value),
        hors3430: ID("s-hors").checked,
        addons: []
      };

      document.querySelectorAll(".addon:checked").forEach(chk => {
        const id = chk.dataset.id;
        const addon = addons.find(a => a.id === id);
        const offert = document.querySelector(`.offert[data-id="${id}"]`).checked;
        line.addons.push({ addonId: id, pu: addon.pu, offert });
      });

      if (idx !== null) lignes[idx] = line;
      else lignes.push(line);

      closeSlide();
      renderLignes();
      showToast("Ligne ajoutée");
    }

    function closeSlide() {
      ID("slideover").classList.remove("open");
    }

    function deleteLigne(idx) {
      if (confirm("Supprimer cette ligne ?")) {
        lignes.splice(idx, 1);
        renderLignes();
        showToast("Ligne supprimée");
      }
    }

    function duplicateLigne(idx) {
      lignes.push(JSON.parse(JSON.stringify(lignes[idx])));
      renderLignes();
      showToast("Ligne dupliquée");
    }

    function editLigne(idx) {
      openLine(idx);
    }

    function newDevis() {
      lignes = [];
      ID("remise-global").value = 0;
      ID("hors3430").checked = false;
      ID("rgpd-ok").checked = false;
      renderLignes();
      showToast("Nouveau devis");
    }

    function telechargerPDF() {
      window.print();
    }

    function envoyerMail() {
      if (!ID("rgpd-ok").checked) {
        alert("Veuillez accepter la clause RGPD.");
        return;
      }
      const email = prompt("Email du client ?");
      const sujet = `Devis CDC — ${new Date().toISOString().slice(0,10)}`;
      const corps = `Bonjour,\n\nVoici votre devis CDC.\n\nMontant TTC : ${ID("total-ttc").textContent}\n\nCordialement,\nCDC Cleaner Drone Crew`;
      window.location.href = `mailto:${email}?subject=${encodeURIComponent(sujet)}&body=${encodeURIComponent(corps)}`;
    }

    window.onload = () => {
      renderLignes();
    };
  </script>
</body>
</html>
