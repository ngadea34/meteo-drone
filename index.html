<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CDC — Calculateur de devis</title>
<style>
  :root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--pri:#2563eb;--ok:#16a34a;--warn:#ea580c;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:20px 24px}
  header h1{font-size:20px;margin:0}
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px 32px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
  .card h2{margin:0;padding:16px 16px 8px;font-size:18px}
  .card .sub{color:var(--muted);padding:0 16px 12px}
  .card .content{padding:16px}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type="number"], input[type="text"], select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
  .opt{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .muted{color:var(--muted)}
  .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 10px;font-size:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn.primary{background:var(--pri);color:#fff;border-color:var(--pri)}
  .btn.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  .total{font-size:22px;font-weight:800}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px 6px;border-bottom:1px dashed var(--border);text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .hl{background:#f3f4f6;border-radius:12px;padding:10px}
  footer{padding:16px;color:var(--muted);text-align:center}
  /* Print */
  @media print{
    header,.noprint{display:none}
    body{background:#fff}
    .wrap{max-width:100%;padding:0}
    .grid{grid-template-columns:1fr 1fr}
    .card{box-shadow:none;border:1px solid #ddd}
  }
</style>
</head>
<body>
<header>
  <h1>CDC — Calculateur de devis</h1>
  <div class="stack noprint">
    <button class="btn" id="resetBtn">Réinitialiser</button>
    <button class="btn primary" onclick="window.print()">Exporter / Imprimer</button>
  </div>
</header>
<div class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Paramètres</h2>
      <div class="sub">Prototype mono‑fichier — Remplir les barèmes depuis « cdc version 2.pdf » (voir objet PRICING dans le code).</div>
      <div class="content">
        <div class="row">
          <div>
            <label for="service">Prestation</label>
            <select id="service"></select>
          </div>
          <div>
            <label for="qty">Quantité (<span id="qtyUnit">m²</span>)</label>
            <input id="qty" type="number" min="0" step="1" value="100" />
          </div>
        </div>

        <div id="dims"></div>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="zone">Zone</label>
            <select id="zone">
              <option value="Z1">Z1 (intra)</option>
              <option value="Z2">Z2 (proche)</option>
              <option value="Z3">Z3 (élargi)</option>
            </select>
          </div>
          <div>
            <label for="km">Kilométrage total <span class="muted">(<span id="kmIncl">0</span> km inclus)</span></label>
            <input id="km" type="number" min="0" step="1" value="10" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Options</label>
          <div id="options" class="row"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Résultat</h2>
      <div class="content">
        <table class="table">
          <tbody>
            <tr><td>Service (HT)</td><td id="serviceHT">—</td></tr>
            <tr><td>Déplacement (HT)</td><td id="depHT">—</td></tr>
            <tr><td>Options (HT)</td><td id="optHT">—</td></tr>
            <tr><td>Coefficient (urgence / nuit)</td><td id="coef">× 1.00</td></tr>
            <tr><th>Total HT</th><th id="totalHT">—</th></tr>
            <tr><td>TVA (<span id="tvaRate">20</span>%)</td><td id="tva">—</td></tr>
            <tr><th>Total TTC</th><th id="totalTTC" class="total">—</th></tr>
          </tbody>
        </table>

        <div class="hl" style="margin-top:12px">
          <b>Durée estimée</b> : ≈ <span id="dureeH">—</span> h — cadence <span id="cadence">—</span>
          <div class="muted" style="font-size:12px;margin-top:4px">Estimation indicative. Sous réserve d'accès, sécurité, rinçages, tests pH/RA, météo et autorisations.</div>
        </div>

        <div style="margin-top:12px">
          <details>
            <summary><b>Détail calcul</b></summary>
            <div id="detail" style="margin-top:8px;font-size:13px"></div>
          </details>
        </div>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>Mentions</h2>
    <div class="content muted" style="font-size:12px">
      Devis généré à titre indicatif. Validité 30 jours. Conditions particulières : sécurité sur site (éventuel parachute/FTS),
      gestion des effluents (capture, filtration, pH/RA), contraintes météorologiques (vent/pluie/températures), autorisations locales.
    </div>
  </section>
</div>
<footer class="noprint">CDC — Prototype v1 HTML autonome</footer>

<script>
// ====== BARÈME — À RENSEIGNER DEPUIS « cdc version 2.pdf » ======
const PRICING = {
  tva: 0.20,
  deplacement: {
    forfaitZone: { Z1: 0, Z2: 45, Z3: 90 },
    coutKm: 0.85,
    inclusKmParZone: { Z1: 20, Z2: 40, Z3: 60 }
  },
  services: {
    facadesHP: {
      label: "Nettoyage façades (haute pression)", unite: "€/m²",
      base: 6.5, minForfait: 450, cadence: 80,
      coefficients: { hauteur: {"<10m":1, "10–20m":1.15, ">20m":1.30}, complexite:{simple:1,moyenne:1.15,complexe:1.30} }
    },
    facadesLP: {
      label: "Nettoyage façades (basse pression/softwash)", unite: "€/m²",
      base: 8.0, minForfait: 480, cadence: 60,
      coefficients: { hauteur: {"<10m":1, "10–20m":1.15, ">20m":1.25}, complexite:{simple:1,moyenne:1.15,complexe:1.25} }
    },
    demoussageToiture: {
      label: "Démoussage toiture (tether + mousse)", unite: "€/m²",
      base: 9.5, minForfait: 520, cadence: 55,
      coefficients: { pente: {"<30°":1, "30–45°":1.15, ">45°":1.30}, complexite:{simple:1,noue:1.15,fragile:1.25} }
    },
    pvNettoyage: {
      label: "Nettoyage panneaux PV", unite: "€/m²",
      base: 5.5, minForfait: 350, cadence: 120,
      coefficients: { encrassement: { faible:1, moyen:1.10, fort:1.25 } }
    },
    pvThermographie: {
      label: "Thermographie PV (drone)", unite: "€/kWc",
      base: 1.2, minForfait: 600, cadence: 500,
      coefficients: { format: { toiture:1.10, ombrieres:1, sol:0.90 } }
    },
    inspectionToiture: {
      label: "Inspection toiture (photos/rapport)", unite: "€/site",
      base: 420, minForfait: 420, cadence: 1,
      coefficients: { complexite: { simple:1, moyenne:1.15, complexe:1.30 } }
    }
  },
  options: {
    eauChaude: { label: "Eau chaude", type: "flat", prix: 90 },
    eauOsmosee: { label: "Eau osmosée/RO", type: "flat", prix: 45 },
    captureEffluents: { label: "Capture & filtration effluents", type: "flat", prix: 120 },
    traitementRA: { label: "Traitement pH/RA local", type: "flat", prix: 65 },
    nacelle: { label: "Location nacelle", type: "jour", prix: 280 },
    secondOperateur: { label: "Second opérateur", type: "heure", prix: 45 },
    urgence24h: { label: "Intervention urgente (<24h)", type: "coef", coef: 1.20 },
    weekendNuit: { label: "Nuit/Weekend", type: "coef", coef: 1.30 },
    rapportPDF: { label: "Rapport détaillé (photos/mesures)", type: "flat", prix: 110 }
  }
};

// ====== Utils ======
const € = (v)=> (v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
const r2 = (v)=> Math.round(v*100)/100;

function computeServiceHT(key, qty, dims){
  const s = PRICING.services[key];
  let unit = s.base;
  const coefTables = s.coefficients||{};
  Object.keys(coefTables).forEach(k=>{
    const choice = dims[k];
    if(choice && coefTables[k][choice]!=null){ unit *= coefTables[k][choice]; }
  });
  const raw = unit * (Number(qty)||0);
  return Math.max(raw, s.minForfait||0);
}
function computeDepHT(zone, km){
  const d = PRICING.deplacement;
  const forfait = d.forfaitZone[zone]||0;
  const inclus = d.inclusKmParZone[zone]||0;
  const surplus = Math.max(0, (Number(km)||0) - inclus);
  return forfait + surplus*(d.coutKm||0);
}
function computeOptionsHT(optState){
  let total=0, coef=1; const descr=[];
  for(const [k,val] of Object.entries(optState)){
    const o = PRICING.options[k]; if(!o) continue;
    if(o.type==='flat' && val){ total+=o.prix; descr.push([o.label, o.prix]); }
    if(o.type==='jour' && val.active){ const t=(val.jours||1)*o.prix; total+=t; descr.push([`${o.label} (${val.jours} j)`, t]); }
    if(o.type==='heure' && val.active){ const t=(val.heures||1)*o.prix; total+=t; descr.push([`${o.label} (${val.heures} h)`, t]); }
    if(o.type==='coef' && val){ coef*=o.coef; descr.push([`${o.label}`, `×${o.coef}`]); }
  }
  return {total, coef, descr};
}

// ====== UI bootstrap ======
const serviceSel = document.querySelector('#service');
const qtyInput  = document.querySelector('#qty');
const qtyUnitEl = document.querySelector('#qtyUnit');
const dimsBox   = document.querySelector('#dims');
const zoneSel   = document.querySelector('#zone');
const kmInput   = document.querySelector('#km');
const kmIncl    = document.querySelector('#kmIncl');
const optWrap   = document.querySelector('#options');

const outServiceHT = document.querySelector('#serviceHT');
const outDepHT     = document.querySelector('#depHT');
const outOptHT     = document.querySelector('#optHT');
const outCoef      = document.querySelector('#coef');
const outTotalHT   = document.querySelector('#totalHT');
const outTVA       = document.querySelector('#tva');
const outTVARate   = document.querySelector('#tvaRate');
const outTotalTTC  = document.querySelector('#totalTTC');
const outCadence   = document.querySelector('#cadence');
const outDuree     = document.querySelector('#dureeH');
const outDetail    = document.querySelector('#detail');

const resetBtn     = document.querySelector('#resetBtn');

// Populate services
for(const [k,v] of Object.entries(PRICING.services)){
  const o=document.createElement('option'); o.value=k; o.textContent=v.label; serviceSel.appendChild(o);
}
serviceSel.value='facadesHP';

// Populate options
const state={
  svcKey:'facadesHP', qty:100, zone:'Z1', km:10,
  dims:{ hauteur:'<10m', complexite:'simple', pente:'<30°', encrassement:'moyen', format:'toiture' },
  opts:{
    eauChaude:false, eauOsmosee:false, captureEffluents:false, traitementRA:false,
    nacelle:{active:false, jours:1}, secondOperateur:{active:false, heures:4},
    urgence24h:false, weekendNuit:false, rapportPDF:false
  }
};

function renderDims(){
  dimsBox.innerHTML='';
  const s = PRICING.services[state.svcKey];
  qtyUnitEl.textContent = s.unite.includes('m²') ? 'm²' : (s.unite.includes('kWc')? 'kWc':'site');
  const coeffs = s.coefficients||{};
  const frag = document.createDocumentFragment();
  const groups = Object.keys(coeffs);
  if(groups.length){
    const wrapper=document.createElement('div');
    wrapper.className = groups.length>=3? 'row3':'row';
    for(const g of groups){
      const div=document.createElement('div');
      const lab=document.createElement('label'); lab.textContent=g.charAt(0).toUpperCase()+g.slice(1);
      const sel=document.createElement('select'); sel.dataset.dim=g;
      for(const k of Object.keys(coeffs[g])){
        const opt=document.createElement('option'); opt.value=k; opt.textContent=k; sel.appendChild(opt);
      }
      sel.value = state.dims[g] || Object.keys(coeffs[g])[0];
      sel.oninput=(e)=>{ state.dims[g]=e.target.value; compute(); };
      div.appendChild(lab); div.appendChild(sel); wrapper.appendChild(div);
    }
    frag.appendChild(wrapper);
  }
  dimsBox.appendChild(frag);
}

function renderOptions(){
  optWrap.innerHTML='';
  const keys = ['eauChaude','eauOsmosee','captureEffluents','traitementRA','rapportPDF','urgence24h','weekendNuit'];
  for(const key of keys){
    const o = PRICING.options[key]; if(!o) continue;
    const div=document.createElement('div'); div.className='opt';
    const left=document.createElement('div');
    left.innerHTML=`<div><b>${o.label}</b></div><div class="muted" style="font-size:12px">${o.type==='coef'?`Coefficient ×${o.coef}`:`${€(o.prix)} ${o.type==='flat'?'forfait':''}`}</div>`;
    const right=document.createElement('input'); right.type='checkbox'; right.checked=!!state.opts[key];
    right.oninput=(e)=>{ state.opts[key]=e.target.checked; compute(); };
    div.appendChild(left); div.appendChild(right); optWrap.appendChild(div);
  }
  // Nacelle
  const nac=document.createElement('div'); nac.className='opt';
  nac.innerHTML=`<div><b>${PRICING.options.nacelle.label}</b><div class="muted" style="font-size:12px">${€(PRICING.options.nacelle.prix)} / jour</div></div>`;
  const rightN=document.createElement('div'); rightN.style.display='flex'; rightN.style.alignItems='center'; rightN.style.gap='8px';
  const toggleN=document.createElement('input'); toggleN.type='checkbox'; toggleN.checked=!!state.opts.nacelle.active;
  const days=document.createElement('input'); days.type='number'; days.min=1; days.value=state.opts.nacelle.jours; days.style.width='80px';
  toggleN.oninput=(e)=>{ state.opts.nacelle.active=e.target.checked; compute(); };
  days.oninput=(e)=>{ state.opts.nacelle.jours=Number(e.target.value||1); compute(); };
  rightN.appendChild(toggleN); rightN.appendChild(days); nac.appendChild(rightN); optWrap.appendChild(nac);

  // Second opérateur
  const so=document.createElement('div'); so.className='opt';
  so.innerHTML=`<div><b>${PRICING.options.secondOperateur.label}</b><div class="muted" style="font-size:12px">${€(PRICING.options.secondOperateur.prix)} / heure</div></div>`;
  const rightS=document.createElement('div'); rightS.style.display='flex'; rightS.style.alignItems='center'; rightS.style.gap='8px';
  const toggleS=document.createElement('input'); toggleS.type='checkbox'; toggleS.checked=!!state.opts.secondOperateur.active;
  const hrs=document.createElement('input'); hrs.type='number'; hrs.min=1; hrs.value=state.opts.secondOperateur.heures; hrs.style.width='80px';
  toggleS.oninput=(e)=>{ state.opts.secondOperateur.active=e.target.checked; compute(); };
  hrs.oninput=(e)=>{ state.opts.secondOperateur.heures=Number(e.target.value||1); compute(); };
  rightS.appendChild(toggleS); rightS.appendChild(hrs); so.appendChild(rightS); optWrap.appendChild(so);
}

function compute(){
  // Units
  const svc = PRICING.services[state.svcKey];
  outCadence.textContent = `${svc.cadence} ${svc.unite.includes('kWc')?'kWc/h':svc.unite.includes('site')?'site/h':'m²/h'}`;
  kmIncl.textContent = PRICING.deplacement.inclusKmParZone[state.zone]||0;
  outTVARate.textContent = Math.round((PRICING.tva||0)*100);

  const svcHT = r2(computeServiceHT(state.svcKey, state.qty, state.dims));
  const depHT = r2(computeDepHT(state.zone, state.km));
  const {total:optHT, coef, descr} = computeOptionsHT(state.opts);
  const totalHT = r2((svcHT + depHT + optHT) * coef);
  const tva = r2(totalHT * PRICING.tva);
  const ttc = r2(totalHT + tva);

  outServiceHT.textContent = €(svcHT);
  outDepHT.textContent     = €(depHT);
  outOptHT.textContent     = €(optHT);
  outCoef.textContent      = `× ${coef.toFixed(2)}`;
  outTotalHT.textContent   = €(totalHT);
  outTVA.textContent       = €(tva);
  outTotalTTC.textContent  = €(ttc);

  // durée (approx = qty/cadence * produit des coeff)
  let timeCoef=1; const coeffs = svc.coefficients||{};
  for(const k of Object.keys(coeffs)){
    const choice=state.dims[k]; if(choice && coeffs[k][choice]) timeCoef *= coeffs[k][choice];
  }
  const baseH = (Number(state.qty)||0) / (svc.cadence||1);
  outDuree.textContent = r2(baseH * timeCoef);

  // Détail
  let html = '';
  html += `<div>Prestation : <b>${svc.label}</b></div>`;
  html += `<div>Quantité : <b>${state.qty}</b> ${svc.unite.includes('kWc')?'kWc':svc.unite.includes('m²')?'m²':'site'}</div>`;
  for(const k of Object.keys(coeffs)){
    const val = state.dims[k]; const c = coeffs[k][val]||1;
    html += `<div>${k} : <b>${val}</b> (coef ${c})</div>`;
  }
  html += `<div>Zone : <b>${state.zone}</b> — ${state.km} km</div>`;
  if(descr.length){
    html += `<div>Options : ${descr.map(d=>`<span class="badge" style="margin-right:6px">${d[0]} ${typeof d[1]==='number'?`(${€(d[1])})`:d[1]}</span>`).join('')}</div>`;
  }
  outDetail.innerHTML = html;
}

// Wire inputs
serviceSel.oninput = (e)=>{ state.svcKey=e.target.value; renderDims(); compute(); };
qtyInput.oninput   = (e)=>{ state.qty=Number(e.target.value||0); compute(); };
zoneSel.oninput    = (e)=>{ state.zone=e.target.value; compute(); };
kmInput.oninput    = (e)=>{ state.km=Number(e.target.value||0); compute(); };

resetBtn.onclick = ()=>{
  serviceSel.value='facadesHP'; state.svcKey='facadesHP';
  qtyInput.value=100; state.qty=100;
  zoneSel.value='Z1'; state.zone='Z1';
  kmInput.value=10; state.km=10;
  state.dims={ hauteur:'<10m', complexite:'simple', pente:'<30°', encrassement:'moyen', format:'toiture' };
  state.opts={ eauChaude:false, eauOsmosee:false, captureEffluents:false, traitementRA:false, nacelle:{active:false, jours:1}, secondOperateur:{active:false, heures:4}, urgence24h:false, weekendNuit:false, rapportPDF:false };
  renderDims(); renderOptions(); compute();
};

renderDims(); renderOptions(); compute();
</script>
</body>
</html>
