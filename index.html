<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>CDC ‚Äì Calculateur de devis</title>
  <style>
    :root {
      --bleu: #1778F2;
      --orange: #FF7A00;
      --gris-clair: #f2f2f2;
      --texte: #333;
      --fond: #fff;
    }
    body {
      margin:0; padding:0;
      font-family:sans-serif;
      color: var(--texte);
      background: var(--fond);
    }
    header {
      position:fixed; top:0; left:0; right:0;
      background: var(--bleu);
      color:#fff;
      padding:10px 20px;
      display:flex; align-items:center; justify-content:space-between;
      z-index:1000;
    }
    header .logo { font-size:1.5em; font-weight:bold; }
    header .coords { font-size:0.9em; }
    header button {
      margin-left:10px; padding:6px 12px;
      border:none; background: var(--orange);
      color:#fff; cursor:pointer;
    }
    main {
      display:flex;
      margin-top:80px;
      padding:20px;
    }
    .col-gauche { flex:2; padding-right:20px; }
    .col-droite {
      flex:1; border-left:1px solid #ccc;
      padding-left:20px;
      position:sticky; top:80px;
      height: calc(100vh - 100px);
      overflow:auto;
    }
    section {
      margin-bottom:15px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    section h2 {
      margin:0; padding:10px;
      background: var(--gris-clair);
      cursor:pointer;
    }
    section .content {
      padding:10px; display:none;
    }
    section.open .content { display:block; }
    label { display:block; margin-bottom:8px; }
    input[type="text"], input[type="number"], input[type="email"], select, textarea {
      width:100%; padding:4px; box-sizing:border-box;
      border:1px solid #aaa; border-radius:3px;
    }
    table {
      width:100%; border-collapse:collapse; font-size:0.9em;
    }
    th, td {
      border:1px solid #aaa; padding:6px;
    }
    th { background: var(--gris-clair); }
    .btn-small {
      padding:4px 8px; font-size:0.8em; cursor:pointer;
      margin-left:2px;
    }
    .tooltip { position:relative; }
    .tooltip:hover::after {
      content: attr(data-desc);
      position:absolute; left:0; top:100%;
      background:#222; color:#fff; padding:4px 8px;
      font-size:0.8em; white-space:nowrap; z-index:100;
      border-radius:3px;
    }
    .slide-over {
      position:fixed; top:0; right:-100%;
      width:360px; max-width:90%; height:100%;
      background:#fff; box-shadow:-2px 0 5px rgba(0,0,0,0.3);
      transition:right 0.3s;
      padding:20px; overflow-y:auto; z-index:2000;
    }
    .slide-over.open { right:0; }
    .totaux div { margin-bottom:8px; }
    .alerte-vent {
      background:#ffcccc; color:#900;
      padding:10px; margin-bottom:10px;
      border:1px solid #900; display:none;
    }
    .modal {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center;
      z-index:3000;
    }
    .modal.open { display:flex; }
    .modal .dialog {
      background:#fff; padding:20px;
      max-width:700px; width:100%; max-height:90%;
      overflow-y:auto; border-radius:5px;
    }
    .tabs { display:flex; border-bottom:1px solid #ccc; }
    .tabs button {
      padding:8px 12px; border:none; background:none; cursor:pointer;
    }
    .tabs button.active {
      border-bottom:2px solid var(--bleu); font-weight:bold;
    }
    .tab-content { display:none; padding-top:10px; }
    .tab-content.active { display:block; }
    #toaster {
      position:fixed; bottom:20px; right:20px;
      background:#333; color:#fff;
      padding:10px 15px; border-radius:4px;
      opacity:0; transition:opacity 0.5s;
      z-index:4000;
    }
    #toaster.show { opacity:1; }
    .error { border-color:red; }
    @media print {
      header button, header .coords, .slide-over, .modal, .tabs,
      section h2, section .content input, section .content select,
      .btn-small { display:none !important; }
      header { position:static; }
      body { margin:0; padding:15mm; }
      main { display:block; }
      table, th, td { border:1px solid #000; }
    }
  </style>
<body>
  <header>
    <div class="logo">CDC Cleaner Drone Crew</div>
    <div class="coords">Adresse ‚Ä¢ Email ‚Ä¢ T√©l√©phone</div>
    <div>
      <button id="btn-new">Nouveau devis</button>
      <button id="btn-admin">Admin</button>
      <button id="btn-print">Imprimer / T√©l√©charger PDF</button>
    </div>
  </header>
  <main>
    <div class="col-gauche">
      <div class="alerte-vent" id="alerteVent"></div>

      <!-- M√©t√©o & Mission -->
      <section id="sec-meteo">
        <h2>Type de mission & m√©t√©o</h2>
        <div class="content">
          <label>Type de mission:
            <select id="missionType">
              <option value="nettoyage">Nettoyage fa√ßades/toitures</option>
              <option value="pv-nettoyage">Nettoyage PV</option>
              <option value="inspection">Inspection</option>
              <option value="thermoPv">Thermo PV</option>
            </select>
          </label>
          <label>Vitesse du vent (km/h):
            <input type="number" id="vent" min="0" />
          </label>
        </div>
      </section>

      <section id="sec-client">
        <h2>Client</h2>
        <div class="content">
          <label>Nom / Soci√©t√©:<input type="text" id="client-name" /></label>
          <label>Email:<input type="email" id="client-email" /></label>
          <label>T√©l√©phone:<input type="text" id="client-phone" /></label>
          <label>Adresse chantier:<input type="text" id="client-address" /></label>
        </div>
      </section>

      <section id="sec-prestations">
        <h2>Prestations (lignes)</h2>
        <div class="content">
          <button id="btn-add-line">Ajouter ligne</button>
          <table id="table-lignes"><thead>
            <tr><th>Prestation</th><th>Qt√©</th><th>Unit√©</th><th>PU</th><th>Min forfait</th><th>Hors 34‚Äë30</th><th>HT ligne</th><th>Actions</th></tr>
          </thead><tbody></tbody></table>
        </div>
      </section>

      <section id="sec-addons">
        <h2>Add‚Äëons</h2>
        <div class="content">
          <div id="global-addons-list"></div>
        </div>
      </section>

      <section id="sec-deplacement">
        <h2>D√©placement</h2>
        <div class="content">
          <label><input type="checkbox" id="chk-hors3430" /> Hors H√©rault/Gard</label>
        </div>
      </section>

      <section id="sec-remise">
        <h2>Remise globale (%)</h2>
        <div class="content">
          <input type="number" id="remisePct" min="0" max="100" value="0" />
        </div>
      </section>

      <section id="sec-validation">
        <h2>Validation & Envoi</h2>
        <div class="content">
          <label><input type="checkbox" id="rgpd" /> J‚Äôaccepte l‚Äôenvoi par email et la conservation locale de mon devis.</label>
          <button id="btn-download">T√©l√©charger PDF</button>
          <button id="btn-email">Envoyer par email</button>
        </div>
      </section>
    </div>

    <div class="col-droite">
      <div class="totaux">
        <div>Devis N¬∞ : <span id="devis-numero">‚Äî</span></div>
        <div>Total HT : <span id="totalHT">0.00 ‚Ç¨</span></div>
        <div>Remise : <span id="remise-val">0.00 ‚Ç¨</span></div>
        <div>TVA (20‚ÄØ%) : <span id="tva-val">0.00 ‚Ç¨</span></div>
        <div>Total TTC : <span id="totalTTC">0.00 ‚Ç¨</span></div>
        <div>Acompte (30‚ÄØ%) : <span id="acompte">0.00 ‚Ç¨</span></div>
        <div>Reste d√ª : <span id="reste">0.00 ‚Ç¨</span></div>
        <div id="footer-deplacement" style="font-size:0.9em; margin-top:10px; display:none;">
          Forfait d√©placement hors 34‚Äë30 inclus au Total HT
        </div>
      </div>
    </div>
  </main>

  <div class="slide-over" id="panel-line">
    <h3 id="panel-title">Nouvelle ligne</h3>
    <form id="form-line">
      <label>Prestation:
        <select id="line-service"></select>
      </label>
      <label>Qt√©:<input type="number" id="line-qte" min="0" step="any" /></label>
      <label>Unit√©:<input type="text" id="line-unite" /></label>
      <label>PU:<input type="number" id="line-pu" min="0" step="any" /></label>
      <label>Min forfait:<input type="number" id="line-min" min="0" step="any" /></label>
      <label>Hors 34‚Äë30:<input type="checkbox" id="line-hors3430" /></label>
      <div id="addons-for-line"></div>
      <button type="submit">Valider</button>
      <button type="button" id="btn-cancel-line">Annuler</button>
    </form>
  </div>

  <div class="modal" id="modal-admin">
    <div class="dialog">
      <h2>Admin</h2>
      <label>Mot de passe:<input type="password" id="admin-pass" /></label>
      <button id="btn-admin-login">Se connecter</button>
      <button id="btn-admin-cancel">Annuler</button>
      <div id="admin-content">
        <div class="tabs">
          <button data-tab="prestations" class="active">Prestations</button>
          <button data-tab="addons">Add‚Äëons</button>
          <button data-tab="deplacement">D√©placement</button>
          <button data-tab="meteo">M√©t√©o</button>
          <button data-tab="mentions">Mentions PDF</button>
          <button data-tab="identite">Identit√©</button>
          <button data-tab="maintenance">Maintenance</button>
        </div>
        <div class="tab-content active" id="tab-prestations"><div id="admin-prestations"></div></div>
        <div class="tab-content" id="tab-addons"><div id="admin-addons"></div></div>
        <div class="tab-content" id="tab-deplacement">
          <label>Forfait Hors 34‚Äë30:<input type="number" id="admin-forfait-h3430" min="0" step="any" /></label>
        </div>
        <div class="tab-content" id="tab-meteo"><div id="admin-seuils"></div></div>
        <div class="tab-content" id="tab-mentions">
          <textarea id="admin-mentions" rows="4" style="width:100%"></textarea>
        </div>
        <div class="tab-content" id="tab-identite">
          <label>Soci√©t√©/Nom:<input type="text" id="admin-company-name" /></label>
          <label>SIREN:<input type="text" id="admin-company-siren" /></label>
          <label>Adresse:<input type="text" id="admin-company-address" /></label>
          <label>Email:<input type="email" id="admin-company-email" /></label>
          <label>T√©l√©phone:<input type="text" id="admin-company-phone" /></label>
          <label>IBAN:<input type="text" id="admin-company-iban" /></label>
          <label>URL CGV:<input type="text" id="admin-company-cgvUrl" /></label>
          <label>Couleur bleu:<input type="color" id="admin-color-bleu" value="#1778F2" /></label>
          <label>Couleur orange:<input type="color" id="admin-color-orange" value="#FF7A00" /></label>
        </div>
        <div class="tab-content" id="tab-maintenance">
          <button id="btn-restore-defaults">Restaurer d√©fauts</button>
          <button id="btn-load-tests">Charger tests</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toaster"></div>

  <script>
    // --- Mod√®les & persistance
    const DEFAULT_SERVICES = [
      {id:"s1",label:"Nettoyage toitures",unite:"m¬≤",pu:9.50,min:520,cadence:55,desc:"D√©moussage/anti‚Äëlichens, rin√ßage ma√Ætris√©."},
      {id:"s2",label:"Fa√ßades (softwash)",unite:"m¬≤",pu:8.00,min:480,cadence:60,desc:"Solution douce, rin√ßage basse pression."},
      {id:"s3",label:"PV ‚Äì Nettoyage",unite:"m¬≤",pu:5.50,min:350,cadence:120,desc:"Eau osmos√©e, perches, sans additif."},
      {id:"s4",label:"PV ‚Äì Thermographie",unite:"site",pu:600,min:600,cadence:1,desc:"Inspection IR par drone, rapport synth√©tique."},
      {id:"s5",label:"Vitrerie/Bardage",unite:"m¬≤",pu:6.00,min:420,cadence:100,desc:"Perches/drones selon acc√®s, essuyage si requis."},
      {id:"s6",label:"Ch√©neaux & goutti√®res",unite:"ml",pu:4.00,min:280,cadence:150,desc:"D√©bouchage, rin√ßage, contr√¥le d‚Äô√©coulement."},
      {id:"s7",label:"Inspection toiture (photo/vid√©o + rapport)",unite:"site",pu:420,min:420,cadence:1,desc:"Inspection HD, rapport 48 h."}
    ];
    const DEFAULT_ADDONS = [
      {id:"a1",label:"D√©moussage",type:"ligne",pu:50,appliesTo:["nettoyage"]},
      {id:"a2",label:"Inspection physique",type:"ligne",pu:80,appliesTo:["all"]},
      {id:"a3",label:"Inspection thermique",type:"ligne",pu:120,appliesTo:["all","pv"]}
    ];
    const DEFAULT_CONFIG = {
      colors:{blue:"#1778F2",orange:"#FF7A00"},
      tva:20, remisePct:0, forfaitHors3430:100,
      seuilsVent:{thermoPv:20,inspection:30,pv:25,nettoyages:35},
      motifsVent:{
        thermoPv:"Thermo PV sensible au vent.",inspection:"S√©curit√© : vent trop fort.",
        pv:"Nettoyage PV non recommand√© par vent fort.",
        nettoyages:"Op√©rations ext√©rieures difficiles par vent."
      },
      mentionsPdf:"Interventions d√©pendantes des conditions m√©t√©o (...). En cas d‚Äôannulation m√©t√©o, reprogrammation rapide garantie.",
      company:{name:"CDC Cleaner Drone Crew",siren:"123456789",address:"Adresse soci√©t√©",email:"contact@cdc.com",phone:"0000000000",iban:"FR76...",cgvUrl:"https://cdc.example.com/cgv"}
    };

    let services, addons, config, devis;
    let devisCounter;

    function lsGet(key, def) {
      let v = localStorage.getItem(key);
      return v ? JSON.parse(v) : def;
    }
    function lsSet(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    }

    function initModels() {
      services = lsGet("cdc_services", DEFAULT_SERVICES);
      addons = lsGet("cdc_addons", DEFAULT_ADDONS);
      config = lsGet("cdc_config", DEFAULT_CONFIG);
      devis = lsGet("cdc_devis", {numero:"",dateISO:"",client:{name:"",email:"",phone:"",address:""},lignes:[],hors3430:false,totalHT:0,remise:0,tva:0,totalTTC:0,acompte:0,resteDu:0});
      devisCounter = parseInt(localStorage.getItem("cdc_devis_counter")||"0",10);
    }
    function saveModels() {
      lsSet("cdc_services",services);
      lsSet("cdc_addons",addons);
      lsSet("cdc_config",config);
      lsSet("cdc_devis",devis);
      localStorage.setItem("cdc_devis_counter",devisCounter);
    }
    function genNumero() {
      if (!devis.numero) {
        let d = new Date();
        let yyyy = d.getFullYear();
        let mm = String(d.getMonth()+1).padStart(2,"0");
        let dd = String(d.getDate()).padStart(2,"0");
        devisCounter++;
        localStorage.setItem("cdc_devis_counter",devisCounter);
        devis.numero = `CDC-${yyyy}${mm}${dd}-${String(devisCounter).padStart(3,"0")}`;
      }
    }

    function round2(x) { return Math.round((x+Number.EPSILON)*100)/100; }

    function calc() {
      let sumLignes = 0;
      devis.lignes.forEach(l => {
        let s = services.find(sv=>sv.id===l.serviceId);
        if (!s) return;
        let base = (l.qte || 0) * l.pu;
        let ht = Math.max(base, l.min || 0);
        let addonsSum = 0;
        l.addons.forEach(ad => { if (!ad.offert) addonsSum += ad.pu; });
        ht += addonsSum;
        l._ht = ht;
        sumLignes += ht;
      });
      let total = sumLignes;
      if (devis.hors3430) total += config.forfaitHors3430;
      let remiseVal = total * (config.remisePct/100);
      let apres = total - remiseVal;
      let tva = apres * (config.tva/100);
      let ttc = apres + tva;
      devis.totalHT = round2(total);
      devis.remise = round2(remiseVal);
      devis.tva = round2(tva);
      devis.totalTTC = round2(ttc);
      devis.acompte = round2(ttc * 0.30);
      devis.resteDu = round2(ttc - devis.acompte);
    }

    function renderSections() {
      ["sec-meteo","sec-client","sec-prestations","sec-addons","sec-deplacement","sec-remise","sec-validation"]
        .forEach(id => {
          let sec = document.getElementById(id);
          let h = sec.querySelector("h2");
          h.onclick = ()=> { sec.classList.toggle("open"); };
        });
    }

    function renderServiceOpts() {
      let sel = document.getElementById("line-service");
      sel.innerHTML = "";
      services.forEach(s=>{ let o=document.createElement("option"); o.value=s.id; o.textContent=s.label; sel.append(o); });
    }

    function renderLines() {
      let tbody = document.querySelector("#table-lignes tbody");
      tbody.innerHTML = "";
      devis.lignes.forEach(l=>{
        let s = services.find(sv=>sv.id===l.serviceId);
        let tr = document.createElement("tr");
        let td0 = document.createElement("td");
        td0.textContent = s.label;
        td0.classList.add("tooltip");
        td0.setAttribute("data-desc", s.desc);
        tr.append(td0);
        ["qte","unite","pu","min"].forEach(f=>{
          let td=document.createElement("td");
          td.textContent = f==="pu"||f==="min" ? (l[f]||0).toFixed(2) : l[f];
          tr.append(td);
        });
        let tdH = document.createElement("td");
        tdH.textContent = l.hors3430 ? "Oui":"Non";
        tr.append(tdH);
        let td_HT = document.createElement("td");
        td_HT.textContent = (l._ht||0).toFixed(2);
        tr.append(td_HT);
        let tdA = document.createElement("td");
        let btnE = document.createElement("button"); btnE.textContent="‚úèÔ∏è"; btnE.classList.add("btn-small");
        btnE.onclick = ()=> openLine(l.id);
        tdA.append(btnE);
        let btnDup=document.createElement("button"); btnDup.textContent="üìÑ"; btnDup.classList.add("btn-small");
        btnDup.onclick = ()=> duplicateLine(l.id);
        tdA.append(btnDup);
        let btnDel=document.createElement("button"); btnDel.textContent="üóë"; btnDel.classList.add("btn-small");
        btnDel.onclick = ()=> { deleteLine(l.id); };
        tdA.append(btnDel);
        tr.append(tdA);
        tbody.append(tr);
      });
    }

    function refresh() {
      genNumero();
      renderServiceOpts();
      calc();
      renderLines();
      renderTotals();
      checkVent();
      saveModels();
    }

    function renderTotals() {
      document.getElementById("devis-numero").textContent = devis.numero;
      document.getElementById("totalHT").textContent = devis.totalHT.toFixed(2)+" ‚Ç¨";
      document.getElementById("remise-val").textContent = (devis.remise||0).toFixed(2)+" ‚Ç¨";
      document.getElementById("tva-val").textContent = devis.tva.toFixed(2)+" ‚Ç¨";
      document.getElementById("totalTTC").textContent = devis.totalTTC.toFixed(2)+" ‚Ç¨";
      document.getElementById("acompte").textContent = devis.acompte.toFixed(2)+" ‚Ç¨";
      document.getElementById("reste").textContent = devis.resteDu.toFixed(2)+" ‚Ç¨";
      document.getElementById("footer-deplacement").style.display = devis.hors3430 ? "block":"none";
    }

    // Ligne gestion
    function openLine(id) {
      let panel = document.getElementById("panel-line");
      panel.classList.add("open");
      let form = document.getElementById("form-line");
      form.dataset.edit = id||"";
      let l = devis.lignes.find(x=>x.id===id);
      renderServiceOpts();
      if (l) {
        document.getElementById("line-service").value = l.serviceId;
        document.getElementById("line-qte").value = l.qte;
        document.getElementById("line-unite").value = l.unite;
        document.getElementById("line-pu").value = l.pu;
        document.getElementById("line-min").value = l.min;
        document.getElementById("line-hors3430").checked = l.hors3430;
      } else {
        document.getElementById("line-service").value = services[0].id;
        document.getElementById("line-qte").value = "";
        document.getElementById("line-unite").value = services[0].unite;
        document.getElementById("line-pu").value = services[0].pu;
        document.getElementById("line-min").value = services[0].min;
        document.getElementById("line-hors3430").checked = false;
      }
    }

    function closeLine() { document.getElementById("panel-line").classList.remove("open"); }

    document.getElementById("btn-add-line").onclick = ()=> openLine("");
    document.getElementById("btn-cancel-line").onclick = closeLine;
    document.getElementById("form-line").onsubmit = function(e){
      e.preventDefault();
      let id = this.dataset.edit;
      let serviceId = document.getElementById("line-service").value;
      let qte = parseFloat(document.getElementById("line-qte").value);
      if (!qte || qte<=0) { alert("Quantit√© invalide"); return; }
      let unite = document.getElementById("line-unite").value;
      let pu = parseFloat(document.getElementById("line-pu").value);
      let min = parseFloat(document.getElementById("line-min").value);
      let hors = document.getElementById("line-hors3430").checked;
      let lad = [];
      addons.forEach(ad=>{
        // simplifi√© : pas les total add-ons par ligne ici
      });
      if (id) {
        let l=devis.lignes.find(x=>x.id===id);
        l.serviceId=serviceId; l.qte=qte; l.unite=unite; l.pu=pu; l.min=min; l.hors3430=hors;
      } else {
        devis.lignes.push({id:"l_"+Date.now(),serviceId, qte, unite, pu, min, hors, addons:[]});
      }
      closeLine();
      refresh();
      showToast("Ligne sauvegard√©e");
    };
    document.addEventListener("keydown",e=>{ if(e.key==="Escape") closeLine(); });
    document.getElementById("remisePct").oninput = e=>{
      config.remisePct = parseFloat(e.target.value)||0;
      refresh();
    };
    document.getElementById("chk-hors3430").onchange = e=>{
      devis.hors3430 = e.target.checked;
      refresh();
    };
    document.getElementById("missionType").onchange = checkVent;
    document.getElementById("vent").oninput = checkVent;
    document.getElementById("btn-download").onclick = ()=> window.print();
    document.getElementById("btn-email").onclick = function(){
      if (!/\S+@\S+\.\S+/.test(devis.client.email || document.getElementById("client-email").value)) { alert("Email invalide"); return; }
      if (!document.getElementById("rgpd").checked) { alert("Vous devez accepter le RGPD"); return; }
      let subj = encodeURIComponent("Devis CDC ‚Äî "+devis.numero);
      let body = `Devis N¬∞: ${devis.numero}\nTotal TTC: ${devis.totalTTC.toFixed(2)} ‚Ç¨\nAcompte: ${devis.acompte.toFixed(2)} ‚Ç¨\nReste d√ª: ${devis.resteDu.toFixed(2)} ‚Ç¨`;
      let mailto = `mailto:${document.getElementById("client-email").value}?subject=${subj}&body=${encodeURIComponent(body)}&cc=nicolas.gadea.pro@gmail.com`;
      window.location.href = mailto;
    };
    document.getElementById("btn-new").onclick = function(){
      if (confirm("Nouveau devis : effacer le devis courant ?")) {
        localStorage.removeItem("cdc_devis");
        initModels();
        refresh();
        showToast("Devis vierge");
      }
    };
    document.getElementById("btn-admin").onclick = function(){ document.getElementById("modal-admin").classList.add("open"); };
    document.getElementById("btn-admin-cancel").onclick = function(){ document.getElementById("modal-admin").classList.remove("open"); };
    document.getElementById("btn-admin-login").onclick = function(){
      if (document.getElementById("admin-pass").value === "Oddysseus-34!") {
        document.getElementById("admin-pass").value="";
        showToast("Admin connect√©");
        document.getElementById("admin-content").style.display="block";
        renderAdmin();
      } else alert("Mot de passe incorrect");
    };
    function renderAdmin(){
      let ap = document.getElementById("admin-prestations");
      ap.innerHTML="";
      services.forEach(s=>{
        let d=document.createElement("div");
        d.textContent=`${s.label} ‚Äî PU:${s.pu.toFixed(2)} ‚Äî min:${s.min.toFixed(2)} ‚Äî unit√©:${s.unite}`;
        let btn = document.createElement("button");
        btn.textContent="‚úèÔ∏è"; btn.classList.add("btn-small");
        btn.onclick=()=> {
          let np = prompt("Nouveau PU pour "+s.label, s.pu);
          if (np!==null) { s.pu=parseFloat(np); lsSet("cdc_services",services); refresh(); }
        };
        d.append(btn);
        ap.append(d);
      }
      );
      let aa = document.getElementById("admin-addons");
      aa.innerHTML="";
      addons.forEach(ad=>{
        let d=document.createElement("div");
        d.textContent=`${ad.label} ‚Äî PU:${ad.pu.toFixed(2)}`;
        let btn = document.createElement("button");
        btn.textContent="‚úèÔ∏è"; btn.classList.add("btn-small");
        btn.onclick=()=> {
          let np = prompt("PU add‚Äëon "+ad.label, ad.pu);
          if (np!==null) { ad.pu=parseFloat(np); lsSet("cdc_addons",addons); refresh(); }
        };
        d.append(btn);
        aa.append(d);
      });
      let inpF = document.getElementById("admin-forfait-h3430");
      inpF.value = config.forfaitHors3430;
      inpF.onchange = e=> { config.forfaitHors3430 = parseFloat(e.target.value)||0; lsSet("cdc_config",config); refresh(); };
      let inpC1 = document.getElementById("admin-company-name");
      inpC1.value = config.company.name;
      inpC1.onchange = e=> { config.company.name = e.target.value; lsSet("cdc_config",config); };
      // idem pour email, phone, siren, etc.
      let cb = document.getElementById("admin-color-bleu");
      cb.value = config.colors.blue;
      cb.onchange = e=> { config.colors.blue = e.target.value; document.documentElement.style.setProperty("--bleu", e.target.value); lsSet("cdc_config",config); };
      let co = document.getElementById("admin-color-orange");
      co.value = config.colors.orange;
      co.onchange = e=> { config.colors.orange = e.target.value; document.documentElement.style.setProperty("--orange", e.target.value); lsSet("cdc_config",config); };
    }
    function restoreDefaults(){
      if (confirm("Restaurer configuration par d√©faut ?")) {
        localStorage.removeItem("cdc_services");
        localStorage.removeItem("cdc_addons");
        localStorage.removeItem("cdc_config");
        initModels();
        refresh();
        showToast("Configuration restaur√©e");
      }
    }
    document.getElementById("btn-restore-defaults").onclick = restoreDefaults;
    document.getElementById("btn-load-tests").onclick = function(){
      if (confirm("Charger cas tests (√©crasera devis actuel) ?")) {
        devis.lignes = [
          {id:"t1",serviceId:"s1",qte:200,unite:services.find(s=>s.id==="s1").unite,pu:services.find(s=>s.id==="s1").pu,min:services.find(s=>s.id==="s1").min,hors3430:false,addons:[]},
          {id:"t2",serviceId:"s4",qte:800,unite:services.find(s=>s.id==="s4").unite,pu:services.find(s=>s.id==="s4").pu,min:services.find(s=>s.id==="s4").min,hors3430:false,addons:[]}
        ];
        refresh();
        showToast("Tests charg√©s");
      }
    };
    function checkVent(){
      let v=parseFloat(document.getElementById("vent").value)||0;
      let t=document.getElementById("missionType").value;
      let seuil = config.seuilsVent[t]||Infinity;
      let motif = config.motifsVent[t]||"";
      let al = document.getElementById("alerteVent");
      if (v > seuil) {
        al.textContent = "‚ö†Ô∏è " + motif;
        al.style.display="block";
      } else al.style.display="none";
    }
    function showToast(m){
      let t = document.getElementById("toaster");
      t.textContent = m;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),2000);
    }

    // Init
    window.onload = function(){
      initModels();
      renderSections();
      refresh();
    };
  </script>
</body>
</html>
