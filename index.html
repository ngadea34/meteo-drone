<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CDC ‚Äì Devis Cleaner Drone Crew</title>
  <style>
    :root {
      --bleu: #1778F2;
      --orange: #FF7A00;
      --gris: #f4f4f4;
    }

    body { margin:0; font-family: system-ui, sans-serif; background:#fff; color:#000; }
    header {
      position: fixed; top:0; left:0; right:0;
      background: var(--bleu); color:white; padding:10px;
      display:flex; justify-content: space-between; align-items:center;
      z-index:1000;
    }
    header h1 { margin:0; font-size:20px; }
    header .actions button { margin-left:10px; }
    main { margin-top:60px; display:flex; }
    .col-gauche { width:65%; padding:10px; }
    .col-droite { width:35%; padding:10px; background:#fafafa; border-left:1px solid #ddd; position:sticky; top:60px; height:calc(100vh - 60px); overflow:auto; }
    section { margin-bottom:20px; background: var(--gris); padding:10px; border-radius:4px; }
    h2 { font-size:18px; margin-bottom:10px; }
    table { width:100%; border-collapse: collapse; background:#fff; }
    th, td { border:1px solid #ccc; padding:5px; text-align:left; }
    th { background:#eee; }
    #slideover {
      position: fixed; top:0; right:-420px; /* cach√© hors √©cran */
      width:420px; height:100%; background:#fff;
      border-left:2px solid #ccc; z-index:1500;
      padding:20px; overflow-y:auto;
      transition: right 0.3s ease;
    }
    #slideover.open { right:0; }
    .toast {
      position: fixed; bottom:20px; right:20px;
      background: var(--orange); color:white;
      padding:10px 20px; border-radius:4px;
      opacity:0; transition: opacity 0.3s ease;
      z-index:2000;
    }
    .toast.show { opacity:1; }
    @media print {
      header, .actions, #slideover, button, input, select { display:none !important; }
      body { background:#fff; }
    }
  </style>
</head>
<body>
  <header>
    <h1>CDC Cleaner Drone Crew</h1>
    <div class="actions">
      <button onclick="newDevis()">Nouveau devis</button>
      <button onclick="showAdmin()">Admin</button>
      <button onclick="window.print()">Imprimer</button>
    </div>
  </header>
  <main>
    <div class="col-gauche">
      <section id="sec-client">
        <h2>Client</h2>
        <label>Nom / Soci√©t√©:<br><input id="client-name" type="text"></label><br>
        <label>Email:<br><input id="client-email" type="email"></label><br>
        <label>T√©l√©phone:<br><input id="client-phone" type="text"></label><br>
        <label>Adresse chantier:<br><input id="client-address" type="text"></label><br>
      </section>

      <section id="sec-prestations">
        <h2>Prestations (lignes)</h2>
        <button onclick="openLine()">Ajouter ligne</button>
        <table id="table-lignes">
          <thead>
            <tr>
              <th>Prestation</th>
              <th>Add-ons</th>
              <th>Qt√©</th>
              <th>Unit√©</th>
              <th>PU</th>
              <th>Min forfait</th>
              <th>Hors 34‚Äë30</th>
              <th>HT ligne</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="lignes-body">
          </tbody>
        </table>
      </section>

      <section id="sec-addons">
        <h2>Add-ons</h2>
        <ul id="global-addons-list">
          <!-- Liste g√©n√©rale des add-ons des lignes -->
        </ul>
      </section>

      <section id="sec-deplacement">
        <h2>D√©placement</h2>
        <label><input type="checkbox" id="hors3430"> Hors H√©rault/Gard</label>
      </section>

      <section id="sec-remise">
        <h2>Remise globale (%)</h2>
        <input type="number" id="remise-global" min="0" max="100" value="0">
      </section>

      <section id="sec-envoi">
        <h2>Validation & Envoi</h2>
        <label><input type="checkbox" id="rgpd-ok"> J‚Äôaccepte l‚Äôenvoi par email et la conservation locale de mon devis.</label><br>
        <button onclick="telechargerPDF()">T√©l√©charger PDF</button>
        <button onclick="envoyerMail()">Envoyer par email</button>
      </section>
    </div>
    <div class="col-droite">
      <div>
        <p><strong>Devis N¬∞ :</strong> <span id="devis-num">‚Äî</span></p>
        <p>Total HT : <span id="total-ht">0.00 ‚Ç¨</span></p>
        <p>Remise : <span id="total-remise">0.00 ‚Ç¨</span></p>
        <p>TVA (20‚ÄØ%) : <span id="total-tva">0.00 ‚Ç¨</span></p>
        <p>Total TTC : <span id="total-ttc">0.00 ‚Ç¨</span></p>
        <p>Acompte (30‚ÄØ%) : <span id="total-acompte">0.00 ‚Ç¨</span></p>
        <p>Reste d√ª : <span id="total-reste">0.00 ‚Ç¨</span></p>
      </div>
    </div>
  </main>

  <div id="slideover"></div>
  <div class="toast" id="toast"></div>

  <script>
    // Persist config de base avec localStorage
    const STORAGE_KEY = "cdc_devis_data";
    const STORAGE_CONF = "cdc_devis_conf";

    let config = JSON.parse(localStorage.getItem(STORAGE_CONF) || "{}");
    if (!config.prestations) {
      // valeurs de base
      config = {
        prestations: [
          { id:"s1", label:"Nettoyage toitures", unite:"‚Ç¨/m¬≤", pu:9.50, min:520, cadence:55, desc:"D√©moussage/anti‚Äëlichens, rin√ßage ma√Ætris√©." },
          { id:"s2", label:"Fa√ßades (softwash)", unite:"‚Ç¨/m¬≤", pu:8.00, min:480, cadence:60, desc:"Solution douce, rin√ßage basse pression." },
          { id:"s3", label:"PV ‚Äì Nettoyage", unite:"‚Ç¨/m¬≤", pu:5.50, min:350, cadence:120, desc:"Eau osmos√©e (0 ppm), perches, sans additif." },
          { id:"s4", label:"PV ‚Äì Thermographie", unite:"‚Ç¨/site", pu:600, min:600, cadence:1, desc:"Inspection IR par drone, rapport synth√©tique." },
          { id:"s5", label:"Vitrerie/Bardage", unite:"‚Ç¨/m¬≤", pu:6.00, min:420, cadence:100, desc:"Perches/drones selon acc√®s, essuyage si requis." },
          { id:"s6", label:"Ch√©neaux & goutti√®res", unite:"‚Ç¨/ml", pu:4.00, min:280, cadence:150, desc:"D√©bouchage, rin√ßage, contr√¥le d‚Äô√©coulement." },
          { id:"s7", label:"Inspection toiture (photo/vid√©o + rapport)", unite:"‚Ç¨/site", pu:420, min:420, cadence:1, desc:"Inspection HD, rapport 48‚ÄØh." }
        ],
        addons: [
          { id:"a1", label:"D√©moussage", pu:50 },
          { id:"a2", label:"Inspection physique", pu:80 },
          { id:"a3", label:"Inspection thermique", pu:120 }
        ],
        forfaitHors3430:100
      };
      localStorage.setItem(STORAGE_CONF, JSON.stringify(config));
    }

    let devisCounter = parseInt(localStorage.getItem("cdc_devis_counter")||"0", 10);

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if (!state.lignes) state = { lignes: [], remisePct:0, hors3430:false, numero:"" };

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      localStorage.setItem(STORAGE_CONF, JSON.stringify(config));
    }

    function round2(x){ return Math.round((x+1e-8)*100)/100; }

    function generateNum(){
      if (!state.numero){
        devisCounter++;
        localStorage.setItem("cdc_devis_counter", devisCounter);
        let d = new Date();
        let y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
        state.numero = `CDC-${y}${m}${dd}-${String(devisCounter).padStart(3,"0")}`;
      }
    }

    function calculHTLigne(l){
      let base = (l.qte * l.pu) || 0;
      if (base < l.min) base = l.min;
      let sumAdd = (l.addons||[]).reduce((acc, ad) => acc + (ad.offert ? 0 : ad.pu), 0);
      return round2(base + sumAdd);
    }

    function calculTotaux(){
      generateNum();
      let totalHT = state.lignes.reduce((s, l) => s + calculHTLigne(l), 0);
      if (state.hors3430) totalHT += config.forfaitHors3430;
      let remise = totalHT * (state.remisePct || 0)/100;
      let apres = totalHT - remise;
      let tva = apres * 0.20;
      let ttc = apres + tva;
      let acompte = ttc * 0.30;
      let reste = ttc - acompte;

      ID("devis-num").textContent = state.numero;
      ID("total-ht").textContent = totalHT.toFixed(2)+" ‚Ç¨";
      ID("total-remise").textContent = remise.toFixed(2)+" ‚Ç¨";
      ID("total-tva").textContent = tva.toFixed(2)+" ‚Ç¨";
      ID("total-ttc").textContent = ttc.toFixed(2)+" ‚Ç¨";
      ID("total-acompte").textContent = acompte.toFixed(2)+" ‚Ç¨";
      ID("total-reste").textContent = reste.toFixed(2)+" ‚Ç¨";

      saveState();
    }

    function renderLignes(){
      const tbody = document.getElementById("lignes-body");
      tbody.innerHTML = "";
      state.lignes.forEach((l, i) => {
        const presta = config.prestations.find(p=>p.id === l.serviceId);
        const label = presta ? presta.label : "";
        const addonsText = (l.addons || []).map(ad => {
          const aConf = config.addons.find(adc => adc.id === ad.addonId);
          return aConf ? `${aConf.label}${ad.offert ? " (offert)" : ""}` : "";
        }).join(", ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${label}</td>
          <td>${addonsText}</td>
          <td>${l.qte}</td>
          <td>${l.unite}</td>
          <td>${l.pu.toFixed(2)}</td>
          <td>${l.min.toFixed(2)}</td>
          <td>${l.hors3430 ? "Oui" : "Non"}</td>
          <td>${calculHTLigne(l).toFixed(2)}</td>
          <td>
            <button onclick="editLigne(${i})">‚úèÔ∏è</button>
            <button onclick="duplicateLigne(${i})">üìÑ</button>
            <button onclick="deleteLigne(${i})">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      calculTotaux();
    }

    function ID(id){ return document.getElementById(id); }

    function openLine(index = null){
      const slide = ID("slideover");
      slide.innerHTML = "";
      slide.classList.add("open");

      const l = (index!=null && state.lignes[index]) ? state.lignes[index] : null;

      let options = config.prestations.map(p => `<option value="${p.id}">${p.label}</option>`).join("");

      slide.innerHTML = `
        <h3>${l ? "Modifier ligne" : "Nouvelle ligne"}</h3>
        <label>Prestation:<br><select id="line-presta">${options}</select></label><br>
        <label>Qt√©:<br><input type="number" id="line-qte" value="${l ? l.qte : ''}"></label><br>
        <label>Unit√©:<br><input type="text" id="line-unite" value="${l ? l.unite : config.prestations.find(p=>p.id === (l?l.serviceId:config.prestations[0].id)).unite}"></label><br>
        <label>PU:<br><input type="number" id="line-pu" step="0.01" value="${l ? l.pu : config.prestations.find(p=>p.id === (l?l.serviceId:config.prestations[0].id)).pu}"></label><br>
        <label>Min forfait:<br><input type="number" id="line-min" step="0.01" value="${l ? l.min : config.prestations.find(p=>p.id === (l?l.serviceId:config.prestations[0].id)).min}"></label><br>
        <label><input type="checkbox" id="line-hors">${l && l.hors3430 ? 'checked' : ''} Hors 34‚Äë30</label><br>
        <div id="line-addons-panel"></div>
        <button onclick="validerLigne(${index})">Valider</button>
        <button onclick="closeSlide()">Annuler</button>
      `;

      ID("line-presta").addEventListener("change", ()=> renderAddonsInPanel(l));

      renderAddonsInPanel(l);
    }

    function renderAddonsInPanel(ligne){
      const panel = ID("line-addons-panel");
      panel.innerHTML = "<p><strong>Add-ons :</strong></p>";
      config.addons.forEach(ad => {
        const existing = ligne ? (ligne.addons || []).find(a=>a.addonId === ad.id) : null;
        const isChecked = existing ? true : false;
        const isOffert = existing ? existing.offert : false;
        panel.innerHTML += `
         <label><input type="checkbox" class="addon-checkbox" data-id="${ad.id}" ${isChecked ? 'checked' : ''}> ${ad.label} (${ad.pu.toFixed(2)} ‚Ç¨)</label><br>
         <label style="margin-left:20px;"><input type="checkbox" class="offert-checkbox" data-id="${ad.id}" ${isOffert ? 'checked' : ''}> Offert</label><br>
        `;
      });
    }

    function validerLigne(idx){
      const serviceId = ID("line-presta").value;
      const presta = config.prestations.find(p=>p.id===serviceId);
      const unit√© = ID("line-unite").value || (presta ? presta.unite : "");
      const qte = parseFloat(ID("line-qte").value) || 0;
      const pu = parseFloat(ID("line-pu").value) || (presta ? presta.pu : 0);
      const min = parseFloat(ID("line-min").value) || (presta ? presta.min : 0);
      const hors = ID("line-hors").checked;

      const addonsSel = [];
      document.querySelectorAll(".addon-checkbox").forEach(chk => {
        if (chk.checked){
          const id = chk.dataset.id;
          const adconf = config.addons.find(ad=>ad.id===id);
          const offChk = document.querySelector(`.offert-checkbox[data-id="${id}"]`);
          const off = offChk && offChk.checked;
          addonsSel.push({ addonId:id, pu: adconf?p arseFloat(adconf.pu):0, offert: !!off });
        }
      });

      const ligne = {
        serviceId: serviceId,
        qte: qte,
        unite: unit√©,
        pu: pu,
        min: min,
        hors3430: hors,
        addons: addonsSel
      };

      if (idx != null && state.lignes[idx]) state.lignes[idx] = ligne;
      else state.lignes.push(ligne);
      saveState();
      closeSlide();
      renderLignes();
    }

    function closeSlide(){
      const slide = ID("slideover");
      slide.classList.remove("open");
      slide.innerHTML = ""; // On vide le slide-over pour lib√©rer l‚Äôespace
    }

    function deleteLigne(idx){
      if (confirm("Supprimer cette ligne ?")){
        state.lignes.splice(idx,1);
        saveState();
        renderLignes();
      }
    }

    function duplicateLigne(idx){
      const copy = JSON.parse(JSON.stringify(state.lignes[idx]));
      state.lignes.push(copy);
      saveState();
      renderLignes();
    }

    function editLigne(idx){
      openLine(idx);
    }

    function newDevis(){
      if (confirm("Effacer le devis courant ?")){
        state = { lignes: [], remisePct:0, hors3430:false, numero:"" };
        saveState();
        renderLignes();
      }
    }

    function telechargerPDF(){
      window.print();
    }
    function envoyerMail(){
      if (!ID("rgpd-ok").checked){
        alert("Veuillez accepter la clause RGPD.");
        return;
      }
      const mail = prompt("Email du client");
      if (!mail) return;
      const sujet = `Devis CDC ‚Äî ${state.numero || ""}`;
      const corps = `Bonjour,\n\nVoici votre devis. Total TTC : ${ID("total-ttc").textContent}\n\nCordialement,\nCDC Cleaner Drone Crew`;
      window.location.href = `mailto:${mail}?subject=${encodeURIComponent(sujet)}&body=${encodeURIComponent(corps)}`;
    }

    window.onload = () => {
      renderLignes();
    };

  </script>
</body>
</html>
