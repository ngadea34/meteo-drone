<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendrier météo — Interventions drone (v4.8)</title>
  <style>
    :root { --bg:#0b0c10; --card:#111217; --muted:#a0a4ad; --text:#e9eef7; --accent:#4cc9f0; --border:#22242b; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans; background:linear-gradient(180deg, #0b0c10, #141622); color:var(--text); }
    .container { max-width:1200px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .card-header { padding:16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .card-title { font-weight:600; font-size:18px; }
    .card-sub { color: var(--muted); font-size:12px; }
    .card-body { padding: 16px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .btn { background:#1b1e29; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn-outline { background: transparent; border:1px solid var(--border); }
    .input, .select { background:#141826; color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:10px; }
    .grid { display:grid; gap:1px; background:var(--border); border-radius:12px; overflow:hidden; }
    .grid-7 { grid-template-columns: repeat(7, minmax(0,1fr)); }
    .cell { min-height:120px; padding:8px; background:#111217; position:relative; border:1px solid rgba(255,255,255,0.06); transition:filter .2s ease; }
    .cell:hover { filter: brightness(1.05); }
    .cell.muted { background:#0e1018; opacity:.65 }
    .cell .day { font-size:12px; color:var(--muted); }
    .badge { font-size:10px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); color:#e8f0ff; background:#0f1f3a; }
    .muted { color: var(--muted); }
    .weekdays { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom:6px; color:var(--muted); font-size:12px; }
    .panel { display:flex; gap:12px; flex-wrap:wrap; }
    .loc-row { display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed var(--border); }
    .footer { margin-top:16px; font-size:12px; color:var(--muted); }
    .debug { margin-top:10px; background:#0e1420; border:1px solid #223; border-radius:8px; padding:10px; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace; color:#a6d3ff; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Calendrier interventions drone</div>
          <div class="card-sub">v4.8 · CAP horizon Open‑Meteo (J+15) · Segments 16j · union des jours · irradiance convertie · export .ics</div>
        </div>
        <div class="row">
          <button id="prevBtn" class="btn btn-outline" title="Mois précédent">⟵</button>
          <div id="monthLabel" style="width: 180px; text-align:center"></div>
          <button id="nextBtn" class="btn btn-outline" title="Mois suivant">⟶</button>
          <button id="todayBtn" class="btn" title="Revenir à aujourd'hui">Aujourd'hui</button>
          <button id="exportBtn" class="btn btn-outline" title="Exporter les jours favorables">Export .ics</button>
        </div>
      </div>
      <div class="card-body">
        <div class="panel">
          <label>Profil
            <select id="profileSelect" class="select"></select>
          </label>
          <label>Seuil favorable
            <input id="favInput" type="number" min="0" max="100" class="input" style="width:80px" />
          </label>
          <label><input id="conservativeChk" type="checkbox" checked/> Mode conservateur (min)</label>
          <label><input id="offlineChk" type="checkbox"/> Mode hors‑ligne (simulé)</label>
        </div>

        <div class="panel" style="margin-top:10px">
          <div><strong>Lieux analysés</strong></div>
          <div id="locList" style="flex:1"></div>
        </div>

        <div id="status" class="muted" style="margin:8px 0"></div>

        <div class="weekdays"><div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div></div>
        <div id="grid" class="grid grid-7"></div>

        <div class="footer">
          Météo : Open‑Meteo · (CORS OK) — Hébergeable en statique.
          <div class="debug" id="debugBox" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  function startOfMonth(d){ const x = new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
  function endOfMonth(d){ const x = startOfMonth(d); x.setMonth(x.getMonth()+1); x.setDate(0); x.setHours(23,59,59,999); return x; }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function subMonths(d, n){ const x = new Date(d); x.setMonth(x.getMonth()-n); return x; }
  function addMonths(d, n){ const x = new Date(d); x.setMonth(x.getMonth()+n); return x; }
  function isSameMonth(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }
  function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function startOfWeek(d){ const x = new Date(d); const day=(x.getDay()+6)%7; return addDays(new Date(x.getFullYear(), x.getMonth(), x.getDate()), -day); }
  function endOfWeek(d){ const s = startOfWeek(d); return addDays(s, 6); }
  function formatMonthFR(d){ return d.toLocaleString('fr-FR', { month:'long', year:'numeric' }); }
  function formatYMD(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function formatICS(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}${m}${day}`; }

  const LOCATIONS=[
    { id:"montpellier", name:"Montpellier centre", lat:43.611, lon:3.877, weight:1 },
    { id:"mauguio", name:"Mauguio (ferme PV)", lat:43.616, lon:4.006, weight:1 },
    { id:"lattes", name:"Lattes", lat:43.567, lon:3.904, weight:1 },
    { id:"castelnau", name:"Castelnau‑le‑Lez", lat:43.633, lon:3.914, weight:1 }
  ];
  const PROFILES=[
    { id:"inspection", label:"Inspection toiture", thresholds:{ demoussage:{ windIdealMax:12, windHardMax:20, rainStrict:false, tempMin:5, tempMax:30 }, favorableThreshold:65 } },
    { id:"thermo", label:"Thermographie PV", thresholds:{ demoussage:{ windIdealMax:12, windHardMax:20, rainStrict:false, tempMin:8, tempMax:28 }, favorableThreshold:70 } },
    { id:"nettoyage", label:"Nettoyage PV", thresholds:{ demoussage:{ windIdealMax:12, windHardMax:20, rainStrict:false, tempMin:10, tempMax:30 }, favorableThreshold:70 } },
    { id:"pulverisation", label:"Pulvérisation (démoussage)", thresholds:{ demoussage:{ windIdealMax:10, windHardMax:18, rainStrict:true, tempMin:8, tempMax:25 }, favorableThreshold:75 } },
  ];
  const TYPES=["PV Cleaning","Thermographie PV","Inspection toiture","Démoussage toiture"];

  function clamp(n,a=0,b=100){ return Math.max(a,Math.min(b,n)); }
  function avg(arr){ return arr.reduce((s,x)=>s+x,0)/(arr.length||1); }
  function hslFromScore(s){ const hue=(s/100)*120; return `hsl(${hue} 85% 68%)`; }
  function scaleDesc(x,a,b){ if(x<=a) return 100; if(x>=b) return 0; return 100*(1-(x-a)/(b-a)); }
  function scaleAsc(x,a,b){ if(x>=b) return 100; if(x<=a) return 0; return 100*(x-a)/(b-a); }
  function scaleBell(x,minG,maxG){ if(x<=minG) return clamp((x/minG)*100); if(x>=maxG) return clamp((maxG/x)*100); return 100; }

  function scoreForType(type,w,thr){
    switch(type){
      case "Thermographie PV":{
        const sWind=scaleDesc(w.wind_gust_kmh,15,35);
        const sRain=w.precip_mm===0?100:(w.precip_mm<2?60:10);
        const sIrr=scaleAsc(w.irradiance_wh_m2,2500,5000);
        const mid=(w.tmin+w.tmax)/2; const sT=100-Math.abs(mid-24)*5;
        return clamp(0.35*sWind + 0.4*sRain + 0.2*sIrr + 0.05*sT);
      }
      case "PV Cleaning":{
        const sWind=scaleDesc(w.wind_gust_kmh,20,40);
        const sRain=w.precip_mm===0?100:(w.precip_mm<1?70:5);
        const mid=(w.tmin+w.tmax)/2; const sT=100-Math.max(0,Math.abs(mid-22)*4);
        return clamp(0.45*sWind + 0.45*sRain + 0.1*sT);
      }
      case "Inspection toiture":{
        const sWind=scaleDesc(w.wind_gust_kmh,25,50);
        const sRain=w.precip_mm===0?100:(w.precip_mm<2?60:10);
        const mid=(w.tmin+w.tmax)/2; const sT=100-Math.max(0,Math.abs(mid-20)*3);
        return clamp(0.5*sWind + 0.45*sRain + 0.05*sT);
      }
      case "Démoussage toiture":{
        const sWind=scaleDesc(w.wind_gust_kmh,thr.demoussage.windIdealMax,thr.demoussage.windHardMax);
        const sRain=thr.demoussage.rainStrict?(w.precip_mm===0?100:0):(w.precip_mm===0?100:10);
        const mid=(w.tmin+w.tmax)/2; const sT=scaleBell(mid,thr.demoussage.tempMin,thr.demoussage.tempMax);
        return clamp(0.55*sWind + 0.35*sRain + 0.1*sT);
      }
      default:return 50;
    }
  }

  function escapeICS(s){ return s.replace(/\/g,"\\").replace(/\n/g,"\n").replace(/,/g,"\,").replace(/;/g,"\;"); }

  let currentMonth=startOfMonth(new Date());
  let conservative=true, offlineMode=false;
  let profiles=[...PROFILES]; let activeProfileId=profiles[0].id; let thresholds=JSON.parse(JSON.stringify(profiles[0].thresholds));
  let locs=[...LOCATIONS]; let selectedLocIds=new Set(locs.map(l=>l.id));
  let byLocForecast={}, forecastByDate={};

  const grid=document.getElementById("grid"), monthLabel=document.getElementById("monthLabel");
  const prevBtn=document.getElementById("prevBtn"), nextBtn=document.getElementById("nextBtn"), todayBtn=document.getElementById("todayBtn"), exportBtn=document.getElementById("exportBtn");
  const statusEl=document.getElementById("status"), profileSelect=document.getElementById("profileSelect"), favInput=document.getElementById("favInput");
  const conservativeChk=document.getElementById("conservativeChk"), offlineChk=document.getElementById("offlineChk"), locList=document.getElementById("locList"), debugBox=document.getElementById("debugBox");

  function renderProfileSelect(){
    profileSelect.innerHTML="";
    for(const p of profiles){
      const o=document.createElement("option");
      o.value=p.id; o.textContent=p.label;
      if(p.id===activeProfileId) o.selected=true;
      profileSelect.appendChild(o);
    }
    favInput.value=thresholds.favorableThreshold; conservativeChk.checked=conservative; offlineChk.checked=offlineMode;
  }
  function renderLocList(){
    locList.innerHTML="";
    for(const l of locs){
      const row=document.createElement("div"); row.className="loc-row";
      const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=selectedLocIds.has(l.id);
      chk.onchange=()=>{ if(chk.checked) selectedLocIds.add(l.id); else selectedLocIds.delete(l.id); refresh(); };
      row.append(chk, document.createTextNode(" "+l.name+"  ("+l.lat.toFixed(5)+", "+l.lon.toFixed(5)+")"));
      locList.appendChild(row);
    }
  }

  function daysForGrid(month){
    const mStart=startOfMonth(month); const mEnd=endOfMonth(mStart);
    const gStart=startOfWeek(mStart); const gEnd=endOfWeek(mEnd);
    const days=[]; for(let d=gStart; d<=gEnd; d=addDays(d,1)) days.push(new Date(d)); return days;
  }

  function aggregateForecast(activeLocs, byLoc){
    const keySet=new Set();
    for(const l of activeLocs){
      const map=byLoc[l.id]||{};
      for(const k of Object.keys(map)) keySet.add(k);
    }
    const dayKeys=Array.from(keySet).sort();
    const out={};
    for(const day of dayKeys){
      let sw=0,wind=0,rain=0,tmin=0,tmax=0,irr=0,cloud=0;
      for(const l of activeLocs){
        const w=(l.weight||1);
        const d=byLoc[l.id]?.[day];
        if(!d) continue;
        sw+=w; wind+=d.wind_gust_kmh*w; rain+=d.precip_mm*w; tmin+=d.tmin*w; tmax+=d.tmax*w; irr+=d.irradiance_wh_m2*w; cloud+=d.cloud_pct*w;
      }
      if(sw===0) continue;
      out[day]={ date:day, wind_gust_kmh:wind/sw, precip_mm:rain/sw, tmin:tmin/sw, tmax:tmax/sw, irradiance_wh_m2:irr/sw, cloud_pct:cloud/sw };
    }
    return out;
  }

  function buildSynthetic(start,end){
    const map={}; let i=0;
    for(let d=start; d<=end; d=addDays(d,1)){
      const key=formatYMD(d);
      const base=Math.sin(i/3)*10;
      const wind=Math.max(5,20+base+(i%5===0?18:0));
      const rain=(i%7===3?8:(i%11===5?20:0));
      const tmin=14+Math.cos(i/5)*4;
      const tmax=26+Math.sin(i/6)*6;
      const cloud=rain>0?80:30+Math.round(Math.abs(Math.cos(i/4))*40);
      const irr=Math.max(1000,4500-cloud*20-rain*30);
      map[key]={date:key, wind_gust_kmh:wind, precip_mm:rain, tmin, tmax, irradiance_wh_m2:irr, cloud_pct:cloud};
      i++;
    }
    return map;
  }

  async function fetchOpenMeteoChunk(lat,lon,start,end){
    const url=new URL("https://api.open-meteo.com/v1/forecast");
    url.searchParams.set("latitude",String(lat));
    url.searchParams.set("longitude",String(lon));
    url.searchParams.set("daily","precipitation_sum,rain_sum,wind_gusts_10m_max,temperature_2m_max,temperature_2m_min,cloudcover_mean,shortwave_radiation_sum");
    url.searchParams.set("timezone","Europe/Paris");
    url.searchParams.set("start_date",start);
    url.searchParams.set("end_date",end);
    if (debugBox) { debugBox.style.display="block"; debugBox.textContent += `GET ${url.toString()}
`; }
    const res=await fetch(url.toString()).catch(err=>({ok:false,status:0,statusText:String(err)}));
    if(!res.ok){ if (debugBox) debugBox.textContent += ` -> ${res.status} ${res.statusText}
`; throw new Error(`Open-Meteo ${res.status}`); }
    const data=await res.json();
    const t=data.daily.time; const wind=data.daily.wind_gusts_10m_max||data.daily.windgusts_10m_max;
    const precip=(data.daily.rain_sum||data.daily.precipitation_sum);
    const tmax=data.daily.temperature_2m_max; const tmin=data.daily.temperature_2m_min;
    const cloud=data.daily.cloudcover_mean; const rad=data.daily.shortwave_radiation_sum; // MJ/m²
    const map={};
    for(let i=0;i<t.length;i++){
      const wv=Number(wind?.[i] ?? 0) || 0;
      const pv=Number(precip?.[i] ?? 0) || 0;
      const tminv=Number(tmin?.[i] ?? 0) || 0;
      const tmaxv=Number(tmax?.[i] ?? 0) || 0;
      const cloudv=Number(cloud?.[i] ?? 0) || 0;
      const radv=Number(rad?.[i] ?? 0) || 0;
      map[t[i]]={
        date:t[i],
        wind_gust_kmh:wv,
        precip_mm:pv,
        tmin:tminv,
        tmax:tmaxv,
        cloud_pct:cloudv,
        irradiance_wh_m2:(radv*277.78)||0
      };
    }
    return map;
  }

  async function fetchOpenMeteoRanged(lat,lon,rangeStart,rangeEnd){
    const maxSpan=16; const out={};
    const today=new Date(); today.setHours(0,0,0,0);
    const horizon=new Date(today); horizon.setDate(horizon.getDate()+15);
    let start=new Date(rangeStart<today?today:rangeStart);
    if(start>rangeEnd || start>horizon) return out;
    let cur=start;
    while(cur<=rangeEnd && cur<=horizon){
      const segStart=new Date(cur);
      const segEnd=addDays(segStart,maxSpan-1);
      const endSeg=new Date(Math.min(segEnd.getTime(), rangeEnd.getTime(), horizon.getTime()));
      const s=formatYMD(segStart), e=formatYMD(endSeg);
      const chunk=await fetchOpenMeteoChunk(lat,lon,s,e);
      Object.assign(out,chunk);
      cur=addDays(endSeg,1);
    }
    return out;
  }

  async function refresh(fetchNow=true){
    monthLabel.textContent=formatMonthFR(currentMonth);
    const days=daysForGrid(currentMonth);
    grid.innerHTML="";
    for(const d of days){
      const cell=document.createElement("div"); cell.className="cell"; if(!isSameMonth(d,currentMonth)) cell.classList.add("muted");
      const top=document.createElement("div"); top.className="row"; top.style.justifyContent='space-between';
      const dayEl=document.createElement("div"); dayEl.className="day"; dayEl.textContent=d.getDate(); top.append(dayEl);
      if(isSameDay(d,new Date())){ const b=document.createElement("span"); b.className="badge"; b.textContent="Aujourd'hui"; top.append(b); }
      cell.append(top);
      const info=document.createElement("div"); info.className="muted"; info.style.fontSize="11px"; info.style.marginTop="6px"; info.textContent="Météo…"; cell.append(info); grid.append(cell);
    }
    const gStart=startOfWeek(startOfMonth(currentMonth)); const gEnd=endOfWeek(endOfMonth(currentMonth));
    statusEl.textContent=offlineMode?"Mode hors‑ligne (simulé)":"Chargement météo…";

    if(fetchNow){
      byLocForecast={}; const activeLocs=locs.filter(l=>selectedLocIds.has(l.id));
      for(const l of activeLocs){
        try{ byLocForecast[l.id]=offlineMode?buildSynthetic(gStart,gEnd):await fetchOpenMeteoRanged(l.lat,l.lon,gStart,gEnd); }
        catch(e){ byLocForecast[l.id]={}; if (debugBox) debugBox.style.display="block", debugBox.textContent += `Lieu: ${l.name} — ${e.message}
`; }
      }
    }

    const activeLocs=locs.filter(l=>selectedLocIds.has(l.id));
    forecastByDate=aggregateForecast(activeLocs,byLocForecast);

    const dayCells=grid.children;
    for(let i=0;i<dayCells.length;i++){
      const cell=dayCells[i]; const d=addDays(startOfWeek(startOfMonth(currentMonth)),i); const key=formatYMD(d); const wx=forecastByDate[key]; const info=cell.querySelector(".muted");
      if(!wx){ info.textContent="Météo indisponible"; continue; }
      const perType=TYPES.map(t=>scoreForType(t,wx,thresholds)); const agg=conservative?Math.min(...perType):avg(perType);
      cell.style.background=hslFromScore(agg);
      const label=agg>=thresholds.favorableThreshold?"Favorable":(agg>=45?"Limite":"Défavorable");
      info.textContent=`${label} · vent ${Math.round(wx.wind_gust_kmh)} km/h · pluie ${wx.precip_mm.toFixed(1)} mm · T° ${Math.round(wx.tmin)}–${Math.round(wx.tmax)}°C`;
    }
    statusEl.textContent="OK";
  }

  function exportICS(){
    const days=daysForGrid(currentMonth);
    let lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//CDC Drone//Meteo Window//FR","CALSCALE:GREGORIAN"];
    for(const d of days){
      const key=formatYMD(d); const wx=forecastByDate[key]; if(!wx) continue;
      const perType=TYPES.map(t=>scoreForType(t,wx,thresholds)); const score=conservative?Math.min(...perType):avg(perType);
      if(score>=thresholds.favorableThreshold){
        const dt=formatICS(d);
        const summary=`Fenêtre météo favorable (${Math.round(score)})`;
        const desc=`Vent rafales ${Math.round(wx.wind_gust_kmh)} km/h; pluie ${wx.precip_mm.toFixed(1)} mm; T° ${Math.round(wx.tmin)}–${Math.round(wx.tmax)}°C; nébulosité ${Math.round(wx.cloud_pct)}%; irr ${Math.round(wx.irradiance_wh_m2)} Wh/m².`;
        lines.push("BEGIN:VEVENT",
          `DTSTART;VALUE=DATE:${dt}`,
          `DTEND;VALUE=DATE:${formatICS(addDays(d,1))}`,
          `UID:${dt}-meteo-cdc@local`,
          `SUMMARY:${escapeICS(summary)}`,
          `DESCRIPTION:${escapeICS(desc)}`,
          "END:VEVENT");
      }
    }
    lines.push("END:VCALENDAR");
    const blob=new Blob([lines.join("
")],{type:"text/calendar;charset=utf-8"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a");
    a.href=url; a.download=`fenetres_meteo_${currentMonth.getFullYear()}_${String(currentMonth.getMonth()+1).padStart(2,'0')}.ics`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  prevBtn.onclick=()=>{ currentMonth=subMonths(currentMonth,1); refresh(); };
  nextBtn.onclick=()=>{ currentMonth=addMonths(currentMonth,1); refresh(); };
  todayBtn.onclick=()=>{ currentMonth=startOfMonth(new Date()); refresh(); };
  exportBtn.onclick=exportICS;
  profileSelect.onchange=()=>{
    activeProfileId=profileSelect.value;
    const p=PROFILES.find(x=>x.id===activeProfileId);
    thresholds=JSON.parse(JSON.stringify(p.thresholds));
    favInput.value=thresholds.favorableThreshold;
    refresh(false);
  };
  favInput.onchange=()=>{ thresholds.favorableThreshold=Number(favInput.value); refresh(false); };
  conservativeChk.onchange=()=>{ conservative=conservativeChk.checked; refresh(false); };
  offlineChk.onchange=()=>{ offlineMode=offlineChk.checked; refresh(); };

  function init(){ renderProfileSelect(); renderLocList(); refresh(); }
  init();
  </script>
</body>
</html>
